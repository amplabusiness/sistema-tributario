{
  "timestamp": "2025-06-23T22:16:31.539Z",
  "duration": "185s",
  "totalRetries": 5,
  "testResults": [
    {
      "retry": 1,
      "timestamp": "2025-06-23T22:14:31.751Z",
      "stats": {
        "total": 0,
        "passed": 0,
        "failed": 0,
        "skipped": 0,
        "coverage": 14.21
      },
      "output": "\n> sistema-tributario-backend@1.0.0 test\n> jest --coverage --verbose --detectOpenHandles\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/sped-fiscal.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 12345678000195\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/sped-fiscal.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:132:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:132:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/new-company.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 98765432000198\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/new-company.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:214:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:214:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/invalid-file.xyz\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/invalid-file.xyz Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:255:22)\n\n  console.log\n    Agente 2 iniciando processamento em lote: 3 arquivos\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:268:13)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc1.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc2.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc3.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc1.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 0)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc2.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 1)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc3.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 2)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.log\n    Agente 2 lote conclu√≠do: batch_1750716847126_kbna06 {\n      totalFiles: 3,\n      successCount: 0,\n      errorCount: 3,\n      companiesFound: 0,\n      companiesRegistered: 0,\n      processingTime: 31\n    }\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:332:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_123\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.log\n    Dados cadastrais consolidados para empresa: emp_123 {\n      dataSources: [\n        'cnpj: undefined',\n        'razaoSocial: undefined',\n        'ie: undefined',\n        'nomeFantasia: undefined',\n        'cnae: undefined'\n      ],\n      consolidatedFields: [ 'cnpj', 'razaoSocial', 'ie', 'nomeFantasia', 'cnae' ]\n    }\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:378:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_999\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.error\n    Erro ao extrair dados cadastrais: emp_999 {\n      error: Error: Nenhum documento encontrado para a empresa: emp_999\n          at DocumentParsingAgent.extractCompanyDataFromDocuments (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:360:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:373:7)\n    }\n\n    \u001b[0m \u001b[90m 384 |\u001b[39m\n     \u001b[90m 385 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 386 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro ao extrair dados cadastrais: ${companyId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 387 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 388 |\u001b[39m     }\n     \u001b[90m 389 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:386:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:373:7)\n\n  console.log\n    Validando e corrigindo dados: doc_123\n\n      at DocumentParsingAgent.log [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:395:13)\n\n  console.error\n    Erro na validacao e corre√ß√£o: doc_123 {\n      error: Error: Documento n√£o encontrado: doc_123\n          at DocumentParsingAgent.validateAndCorrectData (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:400:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:420:22)\n    }\n\n    \u001b[0m \u001b[90m 426 |\u001b[39m\n     \u001b[90m 427 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 428 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro na validacao e corre√ß√£o: ${documentId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 429 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 430 |\u001b[39m     }\n     \u001b[90m 431 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:428:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:420:22)\n\n  console.log\n    Gerando relat√≥rio de extra√ß√£o { companyId: undefined, dateRange: undefined }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:437:13)\n\n  console.log\n    Relat√≥rio de extra√ß√£o gerado { totalDocuments: 2, companiesProcessed: 1 }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:454:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716848143'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716848143' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716848143',\n      itens: 0,\n      regras: 0,\n      confianca: '30%',\n      tempo: '118ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716848274'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.error\n    ‚ùå AGENTE 3: Erro na apuracao ICMS Error: Erro de teste no cache\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\icms-apurador-agent.test.ts:118:39)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 194 |\u001b[39m\n     \u001b[90m 195 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 196 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'‚ùå AGENTE 3: Erro na apuracao ICMS'\u001b[39m\u001b[33m,\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error \u001b[33m:\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'Unknown error'\u001b[39m))\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 197 |\u001b[39m       \n     \u001b[90m 198 |\u001b[39m       \u001b[36mreturn\u001b[39m {\n     \u001b[90m 199 |\u001b[39m         id\u001b[33m:\u001b[39m apuracaoId\u001b[33m,\u001b[39m\u001b[0m\n\n      at ICMSApuradorAgent.error [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:196:15)\n      at Object.<anonymous> (tests/agents/icms-apurador-agent.test.ts:121:25)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716848346'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716848346' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716848346',\n      itens: 4,\n      regras: 0,\n      confianca: '100%',\n      tempo: '16ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.warn\n    [xmldom warning]\tunclosed xml attribute \n    @#[line:1,col:1]\n\n    \u001b[0m \u001b[90m  97 |\u001b[39m     \u001b[36mtry\u001b[39m {\n     \u001b[90m  98 |\u001b[39m       \u001b[90m// Parse do XML\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m  99 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc \u001b[33m=\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mparser\u001b[33m.\u001b[39mparseFromString(xmlContent\u001b[33m,\u001b[39m \u001b[32m'text/xml'\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 100 |\u001b[39m\n     \u001b[90m 101 |\u001b[39m       \u001b[90m// Verificar se o XML √© v√°lido\u001b[39m\n     \u001b[90m 102 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc\u001b[33m.\u001b[39mgetElementsByTagName(\u001b[32m'parsererror'\u001b[39m)\u001b[33m.\u001b[39mlength \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m) {\u001b[0m\n\n      at DOMHandler.warning (../node_modules/xmldom/lib/dom-parser.js:175:11)\n      at parse (../node_modules/xmldom/lib/sax.js:170:20)\n      at XMLReader.parse (../node_modules/xmldom/lib/sax.js:45:3)\n      at DOMParser.Object.<anonymous>.DOMParser.parseFromString (../node_modules/xmldom/lib/dom-parser.js:25:7)\n      at XMLParser.parseFromString [as parseXML] (src/services/parsers/xml-parser.ts:99:33)\n      at Object.<anonymous> (tests/services/parsers/xml-parser.test.ts:227:30)\n\n  console.error\n    Redis connect failed, using memory fallback Error: Connection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:54:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 124 |\u001b[39m       }\n     \u001b[90m 125 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 126 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Redis connect failed, using memory fallback'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 127 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 128 |\u001b[39m     }\n     \u001b[90m 129 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as connect] (src/services/cache.ts:126:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:58:7)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.error\n    Redis disconnect error Error: Disconnection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:90:21)\n\n    \u001b[0m \u001b[90m 134 |\u001b[39m         \u001b[36mawait\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mclient\u001b[33m.\u001b[39mquit()\u001b[33m;\u001b[39m\n     \u001b[90m 135 |\u001b[39m       } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 136 |\u001b[39m         console\u001b[33m.\u001b[39merror(\u001b[32m'Redis disconnect error'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 137 |\u001b[39m       }\n     \u001b[90m 138 |\u001b[39m     }\n     \u001b[90m 139 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as disconnect] (src/services/cache.ts:136:17)\n      at Object.<anonymous> (tests/services/cache.test.ts:94:7)\n\n  console.error\n    Cache get error, falling back to memory Error: Get failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:121:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 150 |\u001b[39m       \u001b[36mreturn\u001b[39m value \u001b[33m?\u001b[39m \u001b[33mJSON\u001b[39m\u001b[33m.\u001b[39mparse(value) \u001b[33m:\u001b[39m \u001b[36mnull\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 151 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 152 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache get error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 153 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 154 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mget\u001b[39m\u001b[33m<\u001b[39m\u001b[33mT\u001b[39m\u001b[33m>\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 155 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as get] (src/services/cache.ts:152:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:124:22)\n\n  console.error\n    Cache set error, falling back to memory Error: Set failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:156:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 167 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 168 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 169 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache set error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 170 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 171 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mset\u001b[39m(key\u001b[33m,\u001b[39m value\u001b[33m,\u001b[39m ttl)\u001b[33m;\u001b[39m\n     \u001b[90m 172 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as set] (src/services/cache.ts:169:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:160:22)\n\n  console.error\n    Cache delete error, falling back to memory Error: Delete failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:187:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 183 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 184 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 185 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache delete error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 186 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 187 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mdelete\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 188 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as delete] (src/services/cache.ts:185:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:190:22)\n\n  console.error\n    Cache exists error, falling back to memory Error: Exists failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:217:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 199 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m===\u001b[39m \u001b[35m1\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 200 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 201 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache exists error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 202 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 203 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39mexists(key)\u001b[33m;\u001b[39m\n     \u001b[90m 204 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as exists] (src/services/cache.ts:201:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:220:22)\n\n  console.error\n    Cache getOrSet error, falling back to memory Error: Factory failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:272:51)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 567 |\u001b[39m       \u001b[36mreturn\u001b[39m value\u001b[33m;\u001b[39m\n     \u001b[90m 568 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 569 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache getOrSet error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 570 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 571 |\u001b[39m       \n     \u001b[90m 572 |\u001b[39m       \u001b[90m// Tentar buscar do cache primeiro\u001b[39m\u001b[0m\n\n      at CacheService.error [as getOrSet] (src/services/cache.ts:569:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:276:7)\n\n  console.log\n    Cache cleared by pattern { pattern: 'test:*', deleted: 2 }\n\n      at CacheService.log [as clearPattern] (src/services/cache.ts:476:17)\n\n  console.error\n    Cache clearPattern error, falling back to memory Error: Clear failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:292:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 480 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 481 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 482 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache clearPattern error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 483 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 484 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 485 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as clearPattern] (src/services/cache.ts:482:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:295:22)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.error\n    Erro na requisi√ß√£o OpenAI { error: 'Chave da API OpenAI n√£o configurada', duration: '1ms' }\n\n    \u001b[0m \u001b[90m 213 |\u001b[39m     \u001b[36mconst\u001b[39m duration \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 214 |\u001b[39m     \n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 215 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Erro na requisi√ß√£o OpenAI'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m     |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 216 |\u001b[39m       error\u001b[33m:\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error\u001b[33m.\u001b[39mmessage \u001b[33m:\u001b[39m \u001b[32m'Unknown error'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 217 |\u001b[39m       duration\u001b[33m:\u001b[39m \u001b[32m`${duration}ms`\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 218 |\u001b[39m     })\u001b[33m;\u001b[39m\u001b[0m\n\n      at error (src/services/openai-service.ts:215:13)\n      at makeOpenAIRequest (src/services/openai-service.ts:257:10)\n      at Object.<anonymous> (tests/services/openai-service.test.ts:195:33)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'password: Senha deve ter pelo menos 8 caracteres' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/test',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido', 'password: Senha muito curta' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:84:20)\n\n  console.error\n    Unexpected error in validation middleware Error: Unexpected error\n        at C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:115:13\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:397:39\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:404:13\n        at mockConstructor (C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:148:19)\n        at validateRequest (C:\\luth\\sistema-tributario\\backend\\src\\middleware\\validation.ts:76:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:118:20)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 92 |\u001b[39m     next()\u001b[33m;\u001b[39m\n     \u001b[90m 93 |\u001b[39m   } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 94 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Unexpected error in validation middleware'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m    |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 95 |\u001b[39m     \n     \u001b[90m 96 |\u001b[39m     res\u001b[33m.\u001b[39mstatus(\u001b[33mHTTP_STATUS\u001b[39m\u001b[33m.\u001b[39m\u001b[33mINTERNAL_SERVER_ERROR\u001b[39m)\u001b[33m.\u001b[39mjson({\n     \u001b[90m 97 |\u001b[39m       success\u001b[33m:\u001b[39m \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at error (src/middleware/validation.ts:94:13)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:118:20)\n\n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nFile                               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                  \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nAll files                          |   14.21 |    12.23 |   11.44 |   14.18 |                                                                                                                    \n config                            |      48 |    66.66 |       0 |   43.47 |                                                                                                                    \n  database.ts                      |   38.09 |      100 |       0 |   31.57 | 6-11,17-21,27-28,32-33                                                                                             \n  index.ts                         |     100 |    66.66 |     100 |     100 | 7-17,22-31,39                                                                                                      \n constants                         |   66.66 |       50 |     100 |   66.66 |                                                                                                                    \n  document.ts                      |       0 |      100 |     100 |       0 | 1-23                                                                                                               \n  federal-rules.ts                 |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  icms-rules.ts                    |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  index.ts                         |     100 |       50 |     100 |     100 | 73                                                                                                                 \n middleware                        |    43.6 |    31.48 |   29.16 |   41.66 |                                                                                                                    \n  auth.ts                          |   67.27 |       56 |      50 |      64 | 80,99-117,133-147,164-167                                                                                          \n  cache.ts                         |       0 |        0 |       0 |       0 | 2-117                                                                                                              \n  validation.ts                    |   61.76 |     37.5 |   57.14 |      60 | 38-63                                                                                                              \n routes                            |    4.62 |     0.69 |    1.46 |    4.63 |                                                                                                                    \n  ai.ts                            |       0 |        0 |       0 |       0 | 6-412                                                                                                              \n  auth.ts                          |   69.23 |    21.73 |      75 |   68.25 | 102-103,138,173-174,190-194,202-203,213-258                                                                        \n  dashboard.ts                     |       0 |        0 |       0 |       0 | 1-271                                                                                                              \n  development-agents.ts            |       0 |        0 |       0 |       0 | 1-331                                                                                                              \n  document-parsing.ts              |       0 |        0 |       0 |       0 | 1-284                                                                                                              \n  documents.ts                     |       0 |        0 |       0 |       0 | 1-752                                                                                                              \n  estoque-ciap.ts                  |       0 |        0 |       0 |       0 | 14-319                                                                                                             \n  federal-apuracao.ts              |       0 |        0 |       0 |       0 | 13-562                                                                                                             \n  icms-apuracao.ts                 |       0 |        0 |       0 |       0 | 12-428                                                                                                             \n  icms.ts                          |       0 |        0 |       0 |       0 | 6-455                                                                                                              \n  index.ts                         |   12.12 |      100 |       0 |   12.12 | 21-158                                                                                                             \n  interface-reporting.ts           |       0 |        0 |       0 |       0 | 13-403                                                                                                             \n  multi-empresa.ts                 |       0 |        0 |       0 |       0 | 1-232                                                                                                              \n  parsing.ts                       |    14.6 |        0 |       0 |   15.47 | 28-374                                                                                                             \n  precificacao-margem.ts           |       0 |        0 |       0 |       0 | 12-550                                                                                                             \n  protege.ts                       |       0 |        0 |       0 |       0 | 1-593                                                                                                              \n  sped-reports.ts                  |       0 |        0 |       0 |       0 | 1-320                                                                                                              \n  test.ts                          |       0 |        0 |       0 |       0 | 1-348                                                                                                              \n  upload.ts                        |   27.41 |        0 |       0 |   27.86 | 27-35,45-58,81-136,153-197,213-233,249-286                                                                         \n  users.ts                         |       0 |        0 |       0 |       0 | 1-311                                                                                                              \n services                          |   19.25 |    20.25 |   17.34 |   19.25 |                                                                                                                    \n  batch-processor.ts               |       0 |        0 |       0 |       0 | 1-369                                                                                                              \n  cache.ts                         |   32.16 |    23.42 |   38.63 |   32.46 | 13-18,29,42-47,73-78,86-88,102,106-108,112-114,144,160,177,193,209-460,467,480,495-531,542-550,575,580-581,593-609 \n  document-indexer.ts              |    3.29 |        0 |       0 |    3.48 | 34-433                                                                                                             \n  document-processor.ts            |    5.68 |        0 |       0 |    5.95 | 34-329                                                                                                             \n  empresa-service.ts               |   30.15 |        0 |   36.36 |   30.15 | 64-68,89-93,121-239,263-304                                                                                        \n  icms-apurador.ts                 |       0 |        0 |       0 |       0 | 19-81                                                                                                              \n  multi-empresa-watcher.ts         |       0 |        0 |       0 |       0 | 1-486                                                                                                              \n  openai-service.ts                |   85.52 |    59.18 |   91.66 |   85.52 | 100-101,105-106,111,115,155,377,390,410-418                                                                        \n  protege-calculator.ts            |       0 |        0 |       0 |       0 | 46-424                                                                                                             \n  protege-service.ts               |       0 |        0 |       0 |       0 | 1-428                                                                                                              \n  queue.ts                         |   66.66 |       50 |       0 |   61.29 | 50-52,56-58,62-64,69,73,77,82,91-97                                                                                \n  watcher.ts                       |   32.45 |    68.29 |   13.33 |   32.74 | 78-142,161-191,210-211,216-230,236-245,251-264,270-285,291-306,324,327,330,333,336                                 \n services/agents                   |   10.69 |     6.56 |   11.72 |   10.63 |                                                                                                                    \n  code-quality-agent.ts            |       0 |      100 |       0 |       0 | 6-40                                                                                                               \n  development-coordinator-agent.ts |       0 |        0 |       0 |       0 | 1-434                                                                                                              \n  devops-agent.ts                  |       0 |        0 |       0 |       0 | 1-293                                                                                                              \n  document-parser-agent.ts         |       0 |        0 |       0 |       0 | 10-767                                                                                                             \n  document-parsing-agent.ts        |   56.52 |    34.21 |   68.18 |   55.61 | 61-173,228-251,300,306-308,313-315,344-345,404-425,462-533                                                         \n  estoque-ciap-agent.ts            |       0 |        0 |       0 |       0 | 12-803                                                                                                             \n  federal-agent.ts                 |       0 |        0 |       0 |       0 | 1-789                                                                                                              \n  frontend-dev-agent.ts            |       0 |        0 |       0 |       0 | 1-409                                                                                                              \n  icms-agent.ts                    |       0 |        0 |       0 |       0 | 1-473                                                                                                              \n  icms-apuracao-agent.ts           |       0 |        0 |       0 |       0 | 10-918                                                                                                             \n  icms-apurador-agent.ts           |   56.25 |    39.06 |   54.28 |   55.88 | 170,188,235-244,253-357,402,423-424,427-429,451-455,468-523,601,631,647,666                                        \n  precificacao-margem-agent.ts     |       0 |        0 |       0 |       0 | 12-879                                                                                                             \n  test-fix-agent.ts                |       0 |        0 |       0 |       0 | 1-431                                                                                                              \n services/parsers                  |   34.82 |    25.42 |   20.63 |   36.36 |                                                                                                                    \n  document-parser.ts               |    7.43 |        0 |       4 |    7.91 | 111-493                                                                                                            \n  icms-rules-excel-parser.ts       |      20 |        0 |       0 |      20 | 20-42                                                                                                              \n  protege-pdf-parser.ts            |     5.4 |        0 |       0 |     5.4 | 29-263                                                                                                             \n  sped-contribuicoes-parser.ts     |       5 |        0 |       0 |    5.26 | 28-123                                                                                                             \n  sped-fiscal-parser.ts            |    5.26 |        0 |       0 |    5.55 | 29-123                                                                                                             \n  xml-parser.ts                    |   78.28 |    64.19 |      75 |   84.17 | 103,117-121,270-309,390,449,471,489-538                                                                            \n services/validators               |   13.15 |        0 |       0 |   13.15 |                                                                                                                    \n  integrity-validator.ts           |   13.15 |        0 |       0 |   13.15 | 24-101                                                                                                             \n services/watchers                 |     5.7 |        0 |       0 |     5.8 |                                                                                                                    \n  api-watcher.ts                   |    4.87 |        0 |       0 |       5 | 25-349                                                                                                             \n  email-watcher.ts                 |    6.54 |        0 |       0 |    6.54 | 20-267                                                                                                             \n  ftp-watcher.ts                   |    5.66 |        0 |       0 |    5.88 | 41-152                                                                                                             \n  google-drive-watcher.ts          |    6.66 |        0 |       0 |    6.81 | 26-277                                                                                                             \n  s3-watcher.ts                    |    5.08 |        0 |       0 |    5.17 | 33-370                                                                                                             \n utils                             |   34.31 |       30 |   29.09 |   35.19 |                                                                                                                    \n  br-utils.ts                      |   96.22 |    81.08 |     100 |   96.07 | 217,237,261,280                                                                                                    \n  cache.ts                         |       0 |        0 |       0 |       0 | 1-200                                                                                                              \n  chunking.ts                      |       0 |        0 |       0 |       0 | 5-53                                                                                                               \n  fallback.ts                      |       0 |        0 |       0 |       0 | 4-27                                                                                                               \n  logger.ts                        |       0 |        0 |       0 |       0 | 1-117                                                                                                              \n  prisma.ts                        |     100 |      100 |     100 |     100 |                                                                                                                    \n  rateLimiter.ts                   |       0 |        0 |       0 |       0 | 4-22                                                                                                               \n  retry.ts                         |       0 |        0 |       0 |       0 | 11-26                                                                                                              \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\n",
      "success": false
    },
    {
      "retry": 2,
      "timestamp": "2025-06-23T22:15:01.220Z",
      "stats": {
        "total": 0,
        "passed": 0,
        "failed": 0,
        "skipped": 0,
        "coverage": 14.21
      },
      "output": "\n> sistema-tributario-backend@1.0.0 test\n> jest --coverage --verbose --detectOpenHandles\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/sped-fiscal.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 12345678000195\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/sped-fiscal.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:132:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:132:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/new-company.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 98765432000198\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/new-company.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:214:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:214:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/invalid-file.xyz\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/invalid-file.xyz Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:255:22)\n\n  console.log\n    Agente 2 iniciando processamento em lote: 3 arquivos\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:268:13)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc1.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc2.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc3.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc1.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 0)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc2.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 1)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc3.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 2)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.log\n    Agente 2 lote conclu√≠do: batch_1750716880840_d5k4kd {\n      totalFiles: 3,\n      successCount: 0,\n      errorCount: 3,\n      companiesFound: 0,\n      companiesRegistered: 0,\n      processingTime: 30\n    }\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:332:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_123\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.log\n    Dados cadastrais consolidados para empresa: emp_123 {\n      dataSources: [\n        'cnpj: undefined',\n        'razaoSocial: undefined',\n        'ie: undefined',\n        'nomeFantasia: undefined',\n        'cnae: undefined'\n      ],\n      consolidatedFields: [ 'cnpj', 'razaoSocial', 'ie', 'nomeFantasia', 'cnae' ]\n    }\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:378:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_999\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.error\n    Erro ao extrair dados cadastrais: emp_999 {\n      error: Error: Nenhum documento encontrado para a empresa: emp_999\n          at DocumentParsingAgent.extractCompanyDataFromDocuments (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:360:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:373:7)\n    }\n\n    \u001b[0m \u001b[90m 384 |\u001b[39m\n     \u001b[90m 385 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 386 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro ao extrair dados cadastrais: ${companyId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 387 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 388 |\u001b[39m     }\n     \u001b[90m 389 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:386:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:373:7)\n\n  console.log\n    Validando e corrigindo dados: doc_123\n\n      at DocumentParsingAgent.log [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:395:13)\n\n  console.error\n    Erro na validacao e corre√ß√£o: doc_123 {\n      error: Error: Documento n√£o encontrado: doc_123\n          at DocumentParsingAgent.validateAndCorrectData (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:400:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:420:22)\n    }\n\n    \u001b[0m \u001b[90m 426 |\u001b[39m\n     \u001b[90m 427 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 428 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro na validacao e corre√ß√£o: ${documentId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 429 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 430 |\u001b[39m     }\n     \u001b[90m 431 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:428:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:420:22)\n\n  console.log\n    Gerando relat√≥rio de extra√ß√£o { companyId: undefined, dateRange: undefined }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:437:13)\n\n  console.log\n    Relat√≥rio de extra√ß√£o gerado { totalDocuments: 2, companiesProcessed: 1 }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:454:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716881679'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716881679' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716881679',\n      itens: 0,\n      regras: 0,\n      confianca: '30%',\n      tempo: '34ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716881732'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.error\n    ‚ùå AGENTE 3: Erro na apuracao ICMS Error: Erro de teste no cache\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\icms-apurador-agent.test.ts:118:39)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 194 |\u001b[39m\n     \u001b[90m 195 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 196 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'‚ùå AGENTE 3: Erro na apuracao ICMS'\u001b[39m\u001b[33m,\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error \u001b[33m:\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'Unknown error'\u001b[39m))\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 197 |\u001b[39m       \n     \u001b[90m 198 |\u001b[39m       \u001b[36mreturn\u001b[39m {\n     \u001b[90m 199 |\u001b[39m         id\u001b[33m:\u001b[39m apuracaoId\u001b[33m,\u001b[39m\u001b[0m\n\n      at ICMSApuradorAgent.error [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:196:15)\n      at Object.<anonymous> (tests/agents/icms-apurador-agent.test.ts:121:25)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716881767'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716881767' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716881767',\n      itens: 4,\n      regras: 0,\n      confianca: '100%',\n      tempo: '5ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.warn\n    [xmldom warning]\tunclosed xml attribute \n    @#[line:1,col:1]\n\n    \u001b[0m \u001b[90m  97 |\u001b[39m     \u001b[36mtry\u001b[39m {\n     \u001b[90m  98 |\u001b[39m       \u001b[90m// Parse do XML\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m  99 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc \u001b[33m=\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mparser\u001b[33m.\u001b[39mparseFromString(xmlContent\u001b[33m,\u001b[39m \u001b[32m'text/xml'\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 100 |\u001b[39m\n     \u001b[90m 101 |\u001b[39m       \u001b[90m// Verificar se o XML √© v√°lido\u001b[39m\n     \u001b[90m 102 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc\u001b[33m.\u001b[39mgetElementsByTagName(\u001b[32m'parsererror'\u001b[39m)\u001b[33m.\u001b[39mlength \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m) {\u001b[0m\n\n      at DOMHandler.warning (../node_modules/xmldom/lib/dom-parser.js:175:11)\n      at parse (../node_modules/xmldom/lib/sax.js:170:20)\n      at XMLReader.parse (../node_modules/xmldom/lib/sax.js:45:3)\n      at DOMParser.Object.<anonymous>.DOMParser.parseFromString (../node_modules/xmldom/lib/dom-parser.js:25:7)\n      at XMLParser.parseFromString [as parseXML] (src/services/parsers/xml-parser.ts:99:33)\n      at Object.<anonymous> (tests/services/parsers/xml-parser.test.ts:227:30)\n\n  console.error\n    Redis connect failed, using memory fallback Error: Connection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:54:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 124 |\u001b[39m       }\n     \u001b[90m 125 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 126 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Redis connect failed, using memory fallback'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 127 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 128 |\u001b[39m     }\n     \u001b[90m 129 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as connect] (src/services/cache.ts:126:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:58:7)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.error\n    Redis disconnect error Error: Disconnection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:90:21)\n\n    \u001b[0m \u001b[90m 134 |\u001b[39m         \u001b[36mawait\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mclient\u001b[33m.\u001b[39mquit()\u001b[33m;\u001b[39m\n     \u001b[90m 135 |\u001b[39m       } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 136 |\u001b[39m         console\u001b[33m.\u001b[39merror(\u001b[32m'Redis disconnect error'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 137 |\u001b[39m       }\n     \u001b[90m 138 |\u001b[39m     }\n     \u001b[90m 139 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as disconnect] (src/services/cache.ts:136:17)\n      at Object.<anonymous> (tests/services/cache.test.ts:94:7)\n\n  console.error\n    Cache get error, falling back to memory Error: Get failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:121:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 150 |\u001b[39m       \u001b[36mreturn\u001b[39m value \u001b[33m?\u001b[39m \u001b[33mJSON\u001b[39m\u001b[33m.\u001b[39mparse(value) \u001b[33m:\u001b[39m \u001b[36mnull\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 151 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 152 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache get error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 153 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 154 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mget\u001b[39m\u001b[33m<\u001b[39m\u001b[33mT\u001b[39m\u001b[33m>\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 155 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as get] (src/services/cache.ts:152:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:124:22)\n\n  console.error\n    Cache set error, falling back to memory Error: Set failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:156:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 167 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 168 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 169 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache set error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 170 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 171 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mset\u001b[39m(key\u001b[33m,\u001b[39m value\u001b[33m,\u001b[39m ttl)\u001b[33m;\u001b[39m\n     \u001b[90m 172 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as set] (src/services/cache.ts:169:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:160:22)\n\n  console.error\n    Cache delete error, falling back to memory Error: Delete failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:187:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 183 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 184 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 185 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache delete error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 186 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 187 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mdelete\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 188 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as delete] (src/services/cache.ts:185:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:190:22)\n\n  console.error\n    Cache exists error, falling back to memory Error: Exists failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:217:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 199 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m===\u001b[39m \u001b[35m1\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 200 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 201 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache exists error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 202 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 203 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39mexists(key)\u001b[33m;\u001b[39m\n     \u001b[90m 204 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as exists] (src/services/cache.ts:201:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:220:22)\n\n  console.error\n    Cache getOrSet error, falling back to memory Error: Factory failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:272:51)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 567 |\u001b[39m       \u001b[36mreturn\u001b[39m value\u001b[33m;\u001b[39m\n     \u001b[90m 568 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 569 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache getOrSet error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 570 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 571 |\u001b[39m       \n     \u001b[90m 572 |\u001b[39m       \u001b[90m// Tentar buscar do cache primeiro\u001b[39m\u001b[0m\n\n      at CacheService.error [as getOrSet] (src/services/cache.ts:569:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:276:7)\n\n  console.log\n    Cache cleared by pattern { pattern: 'test:*', deleted: 2 }\n\n      at CacheService.log [as clearPattern] (src/services/cache.ts:476:17)\n\n  console.error\n    Cache clearPattern error, falling back to memory Error: Clear failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:292:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 480 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 481 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 482 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache clearPattern error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 483 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 484 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 485 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as clearPattern] (src/services/cache.ts:482:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:295:22)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.error\n    Erro na requisi√ß√£o OpenAI { error: 'Chave da API OpenAI n√£o configurada', duration: '0ms' }\n\n    \u001b[0m \u001b[90m 213 |\u001b[39m     \u001b[36mconst\u001b[39m duration \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 214 |\u001b[39m     \n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 215 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Erro na requisi√ß√£o OpenAI'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m     |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 216 |\u001b[39m       error\u001b[33m:\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error\u001b[33m.\u001b[39mmessage \u001b[33m:\u001b[39m \u001b[32m'Unknown error'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 217 |\u001b[39m       duration\u001b[33m:\u001b[39m \u001b[32m`${duration}ms`\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 218 |\u001b[39m     })\u001b[33m;\u001b[39m\u001b[0m\n\n      at error (src/services/openai-service.ts:215:13)\n      at makeOpenAIRequest (src/services/openai-service.ts:257:10)\n      at Object.<anonymous> (tests/services/openai-service.test.ts:195:33)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'password: Senha deve ter pelo menos 8 caracteres' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/test',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido', 'password: Senha muito curta' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:84:20)\n\n  console.error\n    Unexpected error in validation middleware Error: Unexpected error\n        at C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:115:13\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:397:39\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:404:13\n        at mockConstructor (C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:148:19)\n        at validateRequest (C:\\luth\\sistema-tributario\\backend\\src\\middleware\\validation.ts:76:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:118:20)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 92 |\u001b[39m     next()\u001b[33m;\u001b[39m\n     \u001b[90m 93 |\u001b[39m   } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 94 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Unexpected error in validation middleware'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m    |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 95 |\u001b[39m     \n     \u001b[90m 96 |\u001b[39m     res\u001b[33m.\u001b[39mstatus(\u001b[33mHTTP_STATUS\u001b[39m\u001b[33m.\u001b[39m\u001b[33mINTERNAL_SERVER_ERROR\u001b[39m)\u001b[33m.\u001b[39mjson({\n     \u001b[90m 97 |\u001b[39m       success\u001b[33m:\u001b[39m \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at error (src/middleware/validation.ts:94:13)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:118:20)\n\n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nFile                               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                  \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nAll files                          |   14.21 |    12.23 |   11.44 |   14.18 |                                                                                                                    \n config                            |      48 |    66.66 |       0 |   43.47 |                                                                                                                    \n  database.ts                      |   38.09 |      100 |       0 |   31.57 | 6-11,17-21,27-28,32-33                                                                                             \n  index.ts                         |     100 |    66.66 |     100 |     100 | 7-17,22-31,39                                                                                                      \n constants                         |   66.66 |       50 |     100 |   66.66 |                                                                                                                    \n  document.ts                      |       0 |      100 |     100 |       0 | 1-23                                                                                                               \n  federal-rules.ts                 |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  icms-rules.ts                    |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  index.ts                         |     100 |       50 |     100 |     100 | 73                                                                                                                 \n middleware                        |    43.6 |    31.48 |   29.16 |   41.66 |                                                                                                                    \n  auth.ts                          |   67.27 |       56 |      50 |      64 | 80,99-117,133-147,164-167                                                                                          \n  cache.ts                         |       0 |        0 |       0 |       0 | 2-117                                                                                                              \n  validation.ts                    |   61.76 |     37.5 |   57.14 |      60 | 38-63                                                                                                              \n routes                            |    4.62 |     0.69 |    1.46 |    4.63 |                                                                                                                    \n  ai.ts                            |       0 |        0 |       0 |       0 | 6-412                                                                                                              \n  auth.ts                          |   69.23 |    21.73 |      75 |   68.25 | 102-103,138,173-174,190-194,202-203,213-258                                                                        \n  dashboard.ts                     |       0 |        0 |       0 |       0 | 1-271                                                                                                              \n  development-agents.ts            |       0 |        0 |       0 |       0 | 1-331                                                                                                              \n  document-parsing.ts              |       0 |        0 |       0 |       0 | 1-284                                                                                                              \n  documents.ts                     |       0 |        0 |       0 |       0 | 1-752                                                                                                              \n  estoque-ciap.ts                  |       0 |        0 |       0 |       0 | 14-319                                                                                                             \n  federal-apuracao.ts              |       0 |        0 |       0 |       0 | 13-562                                                                                                             \n  icms-apuracao.ts                 |       0 |        0 |       0 |       0 | 12-428                                                                                                             \n  icms.ts                          |       0 |        0 |       0 |       0 | 6-455                                                                                                              \n  index.ts                         |   12.12 |      100 |       0 |   12.12 | 21-158                                                                                                             \n  interface-reporting.ts           |       0 |        0 |       0 |       0 | 13-403                                                                                                             \n  multi-empresa.ts                 |       0 |        0 |       0 |       0 | 1-232                                                                                                              \n  parsing.ts                       |    14.6 |        0 |       0 |   15.47 | 28-374                                                                                                             \n  precificacao-margem.ts           |       0 |        0 |       0 |       0 | 12-550                                                                                                             \n  protege.ts                       |       0 |        0 |       0 |       0 | 1-593                                                                                                              \n  sped-reports.ts                  |       0 |        0 |       0 |       0 | 1-320                                                                                                              \n  test.ts                          |       0 |        0 |       0 |       0 | 1-348                                                                                                              \n  upload.ts                        |   27.41 |        0 |       0 |   27.86 | 27-35,45-58,81-136,153-197,213-233,249-286                                                                         \n  users.ts                         |       0 |        0 |       0 |       0 | 1-311                                                                                                              \n services                          |   19.25 |    20.25 |   17.34 |   19.25 |                                                                                                                    \n  batch-processor.ts               |       0 |        0 |       0 |       0 | 1-369                                                                                                              \n  cache.ts                         |   32.16 |    23.42 |   38.63 |   32.46 | 13-18,29,42-47,73-78,86-88,102,106-108,112-114,144,160,177,193,209-460,467,480,495-531,542-550,575,580-581,593-609 \n  document-indexer.ts              |    3.29 |        0 |       0 |    3.48 | 34-433                                                                                                             \n  document-processor.ts            |    5.68 |        0 |       0 |    5.95 | 34-329                                                                                                             \n  empresa-service.ts               |   30.15 |        0 |   36.36 |   30.15 | 64-68,89-93,121-239,263-304                                                                                        \n  icms-apurador.ts                 |       0 |        0 |       0 |       0 | 19-81                                                                                                              \n  multi-empresa-watcher.ts         |       0 |        0 |       0 |       0 | 1-486                                                                                                              \n  openai-service.ts                |   85.52 |    59.18 |   91.66 |   85.52 | 100-101,105-106,111,115,155,377,390,410-418                                                                        \n  protege-calculator.ts            |       0 |        0 |       0 |       0 | 46-424                                                                                                             \n  protege-service.ts               |       0 |        0 |       0 |       0 | 1-428                                                                                                              \n  queue.ts                         |   66.66 |       50 |       0 |   61.29 | 50-52,56-58,62-64,69,73,77,82,91-97                                                                                \n  watcher.ts                       |   32.45 |    68.29 |   13.33 |   32.74 | 78-142,161-191,210-211,216-230,236-245,251-264,270-285,291-306,324,327,330,333,336                                 \n services/agents                   |   10.69 |     6.56 |   11.72 |   10.63 |                                                                                                                    \n  code-quality-agent.ts            |       0 |      100 |       0 |       0 | 6-40                                                                                                               \n  development-coordinator-agent.ts |       0 |        0 |       0 |       0 | 1-434                                                                                                              \n  devops-agent.ts                  |       0 |        0 |       0 |       0 | 1-293                                                                                                              \n  document-parser-agent.ts         |       0 |        0 |       0 |       0 | 10-767                                                                                                             \n  document-parsing-agent.ts        |   56.52 |    34.21 |   68.18 |   55.61 | 61-173,228-251,300,306-308,313-315,344-345,404-425,462-533                                                         \n  estoque-ciap-agent.ts            |       0 |        0 |       0 |       0 | 12-803                                                                                                             \n  federal-agent.ts                 |       0 |        0 |       0 |       0 | 1-789                                                                                                              \n  frontend-dev-agent.ts            |       0 |        0 |       0 |       0 | 1-409                                                                                                              \n  icms-agent.ts                    |       0 |        0 |       0 |       0 | 1-473                                                                                                              \n  icms-apuracao-agent.ts           |       0 |        0 |       0 |       0 | 10-918                                                                                                             \n  icms-apurador-agent.ts           |   56.25 |    39.06 |   54.28 |   55.88 | 170,188,235-244,253-357,402,423-424,427-429,451-455,468-523,601,631,647,666                                        \n  precificacao-margem-agent.ts     |       0 |        0 |       0 |       0 | 12-879                                                                                                             \n  test-fix-agent.ts                |       0 |        0 |       0 |       0 | 1-431                                                                                                              \n services/parsers                  |   34.82 |    25.42 |   20.63 |   36.36 |                                                                                                                    \n  document-parser.ts               |    7.43 |        0 |       4 |    7.91 | 111-493                                                                                                            \n  icms-rules-excel-parser.ts       |      20 |        0 |       0 |      20 | 20-42                                                                                                              \n  protege-pdf-parser.ts            |     5.4 |        0 |       0 |     5.4 | 29-263                                                                                                             \n  sped-contribuicoes-parser.ts     |       5 |        0 |       0 |    5.26 | 28-123                                                                                                             \n  sped-fiscal-parser.ts            |    5.26 |        0 |       0 |    5.55 | 29-123                                                                                                             \n  xml-parser.ts                    |   78.28 |    64.19 |      75 |   84.17 | 103,117-121,270-309,390,449,471,489-538                                                                            \n services/validators               |   13.15 |        0 |       0 |   13.15 |                                                                                                                    \n  integrity-validator.ts           |   13.15 |        0 |       0 |   13.15 | 24-101                                                                                                             \n services/watchers                 |     5.7 |        0 |       0 |     5.8 |                                                                                                                    \n  api-watcher.ts                   |    4.87 |        0 |       0 |       5 | 25-349                                                                                                             \n  email-watcher.ts                 |    6.54 |        0 |       0 |    6.54 | 20-267                                                                                                             \n  ftp-watcher.ts                   |    5.66 |        0 |       0 |    5.88 | 41-152                                                                                                             \n  google-drive-watcher.ts          |    6.66 |        0 |       0 |    6.81 | 26-277                                                                                                             \n  s3-watcher.ts                    |    5.08 |        0 |       0 |    5.17 | 33-370                                                                                                             \n utils                             |   34.31 |       30 |   29.09 |   35.19 |                                                                                                                    \n  br-utils.ts                      |   96.22 |    81.08 |     100 |   96.07 | 217,237,261,280                                                                                                    \n  cache.ts                         |       0 |        0 |       0 |       0 | 1-200                                                                                                              \n  chunking.ts                      |       0 |        0 |       0 |       0 | 5-53                                                                                                               \n  fallback.ts                      |       0 |        0 |       0 |       0 | 4-27                                                                                                               \n  logger.ts                        |       0 |        0 |       0 |       0 | 1-117                                                                                                              \n  prisma.ts                        |     100 |      100 |     100 |     100 |                                                                                                                    \n  rateLimiter.ts                   |       0 |        0 |       0 |       0 | 4-22                                                                                                               \n  retry.ts                         |       0 |        0 |       0 |       0 | 11-26                                                                                                              \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\n",
      "success": false
    },
    {
      "retry": 3,
      "timestamp": "2025-06-23T22:15:31.296Z",
      "stats": {
        "total": 0,
        "passed": 0,
        "failed": 0,
        "skipped": 0,
        "coverage": 14.21
      },
      "output": "\n> sistema-tributario-backend@1.0.0 test\n> jest --coverage --verbose --detectOpenHandles\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/sped-fiscal.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 12345678000195\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/sped-fiscal.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:132:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:132:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/new-company.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 98765432000198\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/new-company.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:214:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:214:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/invalid-file.xyz\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/invalid-file.xyz Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:255:22)\n\n  console.log\n    Agente 2 iniciando processamento em lote: 3 arquivos\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:268:13)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc1.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc2.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc3.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc1.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 0)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc2.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 1)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc3.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 2)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.log\n    Agente 2 lote conclu√≠do: batch_1750716910559_1obn60 {\n      totalFiles: 3,\n      successCount: 0,\n      errorCount: 3,\n      companiesFound: 0,\n      companiesRegistered: 0,\n      processingTime: 37\n    }\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:332:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_123\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.log\n    Dados cadastrais consolidados para empresa: emp_123 {\n      dataSources: [\n        'cnpj: undefined',\n        'razaoSocial: undefined',\n        'ie: undefined',\n        'nomeFantasia: undefined',\n        'cnae: undefined'\n      ],\n      consolidatedFields: [ 'cnpj', 'razaoSocial', 'ie', 'nomeFantasia', 'cnae' ]\n    }\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:378:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_999\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.error\n    Erro ao extrair dados cadastrais: emp_999 {\n      error: Error: Nenhum documento encontrado para a empresa: emp_999\n          at DocumentParsingAgent.extractCompanyDataFromDocuments (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:360:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:373:7)\n    }\n\n    \u001b[0m \u001b[90m 384 |\u001b[39m\n     \u001b[90m 385 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 386 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro ao extrair dados cadastrais: ${companyId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 387 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 388 |\u001b[39m     }\n     \u001b[90m 389 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:386:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:373:7)\n\n  console.log\n    Validando e corrigindo dados: doc_123\n\n      at DocumentParsingAgent.log [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:395:13)\n\n  console.error\n    Erro na validacao e corre√ß√£o: doc_123 {\n      error: Error: Documento n√£o encontrado: doc_123\n          at DocumentParsingAgent.validateAndCorrectData (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:400:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:420:22)\n    }\n\n    \u001b[0m \u001b[90m 426 |\u001b[39m\n     \u001b[90m 427 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 428 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro na validacao e corre√ß√£o: ${documentId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 429 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 430 |\u001b[39m     }\n     \u001b[90m 431 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:428:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:420:22)\n\n  console.log\n    Gerando relat√≥rio de extra√ß√£o { companyId: undefined, dateRange: undefined }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:437:13)\n\n  console.log\n    Relat√≥rio de extra√ß√£o gerado { totalDocuments: 2, companiesProcessed: 1 }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:454:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716911394'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716911394' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716911394',\n      itens: 0,\n      regras: 0,\n      confianca: '30%',\n      tempo: '42ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716911457'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.error\n    ‚ùå AGENTE 3: Erro na apuracao ICMS Error: Erro de teste no cache\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\icms-apurador-agent.test.ts:118:39)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 194 |\u001b[39m\n     \u001b[90m 195 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 196 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'‚ùå AGENTE 3: Erro na apuracao ICMS'\u001b[39m\u001b[33m,\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error \u001b[33m:\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'Unknown error'\u001b[39m))\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 197 |\u001b[39m       \n     \u001b[90m 198 |\u001b[39m       \u001b[36mreturn\u001b[39m {\n     \u001b[90m 199 |\u001b[39m         id\u001b[33m:\u001b[39m apuracaoId\u001b[33m,\u001b[39m\u001b[0m\n\n      at ICMSApuradorAgent.error [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:196:15)\n      at Object.<anonymous> (tests/agents/icms-apurador-agent.test.ts:121:25)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716911507'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716911507' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716911507',\n      itens: 4,\n      regras: 0,\n      confianca: '100%',\n      tempo: '4ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.warn\n    [xmldom warning]\tunclosed xml attribute \n    @#[line:1,col:1]\n\n    \u001b[0m \u001b[90m  97 |\u001b[39m     \u001b[36mtry\u001b[39m {\n     \u001b[90m  98 |\u001b[39m       \u001b[90m// Parse do XML\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m  99 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc \u001b[33m=\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mparser\u001b[33m.\u001b[39mparseFromString(xmlContent\u001b[33m,\u001b[39m \u001b[32m'text/xml'\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 100 |\u001b[39m\n     \u001b[90m 101 |\u001b[39m       \u001b[90m// Verificar se o XML √© v√°lido\u001b[39m\n     \u001b[90m 102 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc\u001b[33m.\u001b[39mgetElementsByTagName(\u001b[32m'parsererror'\u001b[39m)\u001b[33m.\u001b[39mlength \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m) {\u001b[0m\n\n      at DOMHandler.warning (../node_modules/xmldom/lib/dom-parser.js:175:11)\n      at parse (../node_modules/xmldom/lib/sax.js:170:20)\n      at XMLReader.parse (../node_modules/xmldom/lib/sax.js:45:3)\n      at DOMParser.Object.<anonymous>.DOMParser.parseFromString (../node_modules/xmldom/lib/dom-parser.js:25:7)\n      at XMLParser.parseFromString [as parseXML] (src/services/parsers/xml-parser.ts:99:33)\n      at Object.<anonymous> (tests/services/parsers/xml-parser.test.ts:227:30)\n\n  console.error\n    Redis connect failed, using memory fallback Error: Connection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:54:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 124 |\u001b[39m       }\n     \u001b[90m 125 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 126 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Redis connect failed, using memory fallback'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 127 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 128 |\u001b[39m     }\n     \u001b[90m 129 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as connect] (src/services/cache.ts:126:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:58:7)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.error\n    Redis disconnect error Error: Disconnection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:90:21)\n\n    \u001b[0m \u001b[90m 134 |\u001b[39m         \u001b[36mawait\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mclient\u001b[33m.\u001b[39mquit()\u001b[33m;\u001b[39m\n     \u001b[90m 135 |\u001b[39m       } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 136 |\u001b[39m         console\u001b[33m.\u001b[39merror(\u001b[32m'Redis disconnect error'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 137 |\u001b[39m       }\n     \u001b[90m 138 |\u001b[39m     }\n     \u001b[90m 139 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as disconnect] (src/services/cache.ts:136:17)\n      at Object.<anonymous> (tests/services/cache.test.ts:94:7)\n\n  console.error\n    Cache get error, falling back to memory Error: Get failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:121:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 150 |\u001b[39m       \u001b[36mreturn\u001b[39m value \u001b[33m?\u001b[39m \u001b[33mJSON\u001b[39m\u001b[33m.\u001b[39mparse(value) \u001b[33m:\u001b[39m \u001b[36mnull\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 151 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 152 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache get error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 153 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 154 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mget\u001b[39m\u001b[33m<\u001b[39m\u001b[33mT\u001b[39m\u001b[33m>\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 155 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as get] (src/services/cache.ts:152:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:124:22)\n\n  console.error\n    Cache set error, falling back to memory Error: Set failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:156:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 167 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 168 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 169 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache set error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 170 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 171 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mset\u001b[39m(key\u001b[33m,\u001b[39m value\u001b[33m,\u001b[39m ttl)\u001b[33m;\u001b[39m\n     \u001b[90m 172 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as set] (src/services/cache.ts:169:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:160:22)\n\n  console.error\n    Cache delete error, falling back to memory Error: Delete failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:187:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 183 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 184 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 185 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache delete error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 186 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 187 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mdelete\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 188 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as delete] (src/services/cache.ts:185:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:190:22)\n\n  console.error\n    Cache exists error, falling back to memory Error: Exists failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:217:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 199 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m===\u001b[39m \u001b[35m1\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 200 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 201 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache exists error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 202 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 203 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39mexists(key)\u001b[33m;\u001b[39m\n     \u001b[90m 204 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as exists] (src/services/cache.ts:201:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:220:22)\n\n  console.error\n    Cache getOrSet error, falling back to memory Error: Factory failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:272:51)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 567 |\u001b[39m       \u001b[36mreturn\u001b[39m value\u001b[33m;\u001b[39m\n     \u001b[90m 568 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 569 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache getOrSet error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 570 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 571 |\u001b[39m       \n     \u001b[90m 572 |\u001b[39m       \u001b[90m// Tentar buscar do cache primeiro\u001b[39m\u001b[0m\n\n      at CacheService.error [as getOrSet] (src/services/cache.ts:569:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:276:7)\n\n  console.log\n    Cache cleared by pattern { pattern: 'test:*', deleted: 2 }\n\n      at CacheService.log [as clearPattern] (src/services/cache.ts:476:17)\n\n  console.error\n    Cache clearPattern error, falling back to memory Error: Clear failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:292:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 480 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 481 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 482 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache clearPattern error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 483 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 484 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 485 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as clearPattern] (src/services/cache.ts:482:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:295:22)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.error\n    Erro na requisi√ß√£o OpenAI { error: 'Chave da API OpenAI n√£o configurada', duration: '0ms' }\n\n    \u001b[0m \u001b[90m 213 |\u001b[39m     \u001b[36mconst\u001b[39m duration \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 214 |\u001b[39m     \n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 215 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Erro na requisi√ß√£o OpenAI'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m     |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 216 |\u001b[39m       error\u001b[33m:\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error\u001b[33m.\u001b[39mmessage \u001b[33m:\u001b[39m \u001b[32m'Unknown error'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 217 |\u001b[39m       duration\u001b[33m:\u001b[39m \u001b[32m`${duration}ms`\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 218 |\u001b[39m     })\u001b[33m;\u001b[39m\u001b[0m\n\n      at error (src/services/openai-service.ts:215:13)\n      at makeOpenAIRequest (src/services/openai-service.ts:257:10)\n      at Object.<anonymous> (tests/services/openai-service.test.ts:195:33)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'password: Senha deve ter pelo menos 8 caracteres' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/test',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido', 'password: Senha muito curta' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:84:20)\n\n  console.error\n    Unexpected error in validation middleware Error: Unexpected error\n        at C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:115:13\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:397:39\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:404:13\n        at mockConstructor (C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:148:19)\n        at validateRequest (C:\\luth\\sistema-tributario\\backend\\src\\middleware\\validation.ts:76:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:118:20)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 92 |\u001b[39m     next()\u001b[33m;\u001b[39m\n     \u001b[90m 93 |\u001b[39m   } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 94 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Unexpected error in validation middleware'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m    |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 95 |\u001b[39m     \n     \u001b[90m 96 |\u001b[39m     res\u001b[33m.\u001b[39mstatus(\u001b[33mHTTP_STATUS\u001b[39m\u001b[33m.\u001b[39m\u001b[33mINTERNAL_SERVER_ERROR\u001b[39m)\u001b[33m.\u001b[39mjson({\n     \u001b[90m 97 |\u001b[39m       success\u001b[33m:\u001b[39m \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at error (src/middleware/validation.ts:94:13)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:118:20)\n\n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nFile                               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                  \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nAll files                          |   14.21 |    12.23 |   11.44 |   14.18 |                                                                                                                    \n config                            |      48 |    66.66 |       0 |   43.47 |                                                                                                                    \n  database.ts                      |   38.09 |      100 |       0 |   31.57 | 6-11,17-21,27-28,32-33                                                                                             \n  index.ts                         |     100 |    66.66 |     100 |     100 | 7-17,22-31,39                                                                                                      \n constants                         |   66.66 |       50 |     100 |   66.66 |                                                                                                                    \n  document.ts                      |       0 |      100 |     100 |       0 | 1-23                                                                                                               \n  federal-rules.ts                 |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  icms-rules.ts                    |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  index.ts                         |     100 |       50 |     100 |     100 | 73                                                                                                                 \n middleware                        |    43.6 |    31.48 |   29.16 |   41.66 |                                                                                                                    \n  auth.ts                          |   67.27 |       56 |      50 |      64 | 80,99-117,133-147,164-167                                                                                          \n  cache.ts                         |       0 |        0 |       0 |       0 | 2-117                                                                                                              \n  validation.ts                    |   61.76 |     37.5 |   57.14 |      60 | 38-63                                                                                                              \n routes                            |    4.62 |     0.69 |    1.46 |    4.63 |                                                                                                                    \n  ai.ts                            |       0 |        0 |       0 |       0 | 6-412                                                                                                              \n  auth.ts                          |   69.23 |    21.73 |      75 |   68.25 | 102-103,138,173-174,190-194,202-203,213-258                                                                        \n  dashboard.ts                     |       0 |        0 |       0 |       0 | 1-271                                                                                                              \n  development-agents.ts            |       0 |        0 |       0 |       0 | 1-331                                                                                                              \n  document-parsing.ts              |       0 |        0 |       0 |       0 | 1-284                                                                                                              \n  documents.ts                     |       0 |        0 |       0 |       0 | 1-752                                                                                                              \n  estoque-ciap.ts                  |       0 |        0 |       0 |       0 | 14-319                                                                                                             \n  federal-apuracao.ts              |       0 |        0 |       0 |       0 | 13-562                                                                                                             \n  icms-apuracao.ts                 |       0 |        0 |       0 |       0 | 12-428                                                                                                             \n  icms.ts                          |       0 |        0 |       0 |       0 | 6-455                                                                                                              \n  index.ts                         |   12.12 |      100 |       0 |   12.12 | 21-158                                                                                                             \n  interface-reporting.ts           |       0 |        0 |       0 |       0 | 13-403                                                                                                             \n  multi-empresa.ts                 |       0 |        0 |       0 |       0 | 1-232                                                                                                              \n  parsing.ts                       |    14.6 |        0 |       0 |   15.47 | 28-374                                                                                                             \n  precificacao-margem.ts           |       0 |        0 |       0 |       0 | 12-550                                                                                                             \n  protege.ts                       |       0 |        0 |       0 |       0 | 1-593                                                                                                              \n  sped-reports.ts                  |       0 |        0 |       0 |       0 | 1-320                                                                                                              \n  test.ts                          |       0 |        0 |       0 |       0 | 1-348                                                                                                              \n  upload.ts                        |   27.41 |        0 |       0 |   27.86 | 27-35,45-58,81-136,153-197,213-233,249-286                                                                         \n  users.ts                         |       0 |        0 |       0 |       0 | 1-311                                                                                                              \n services                          |   19.25 |    20.25 |   17.34 |   19.25 |                                                                                                                    \n  batch-processor.ts               |       0 |        0 |       0 |       0 | 1-369                                                                                                              \n  cache.ts                         |   32.16 |    23.42 |   38.63 |   32.46 | 13-18,29,42-47,73-78,86-88,102,106-108,112-114,144,160,177,193,209-460,467,480,495-531,542-550,575,580-581,593-609 \n  document-indexer.ts              |    3.29 |        0 |       0 |    3.48 | 34-433                                                                                                             \n  document-processor.ts            |    5.68 |        0 |       0 |    5.95 | 34-329                                                                                                             \n  empresa-service.ts               |   30.15 |        0 |   36.36 |   30.15 | 64-68,89-93,121-239,263-304                                                                                        \n  icms-apurador.ts                 |       0 |        0 |       0 |       0 | 19-81                                                                                                              \n  multi-empresa-watcher.ts         |       0 |        0 |       0 |       0 | 1-486                                                                                                              \n  openai-service.ts                |   85.52 |    59.18 |   91.66 |   85.52 | 100-101,105-106,111,115,155,377,390,410-418                                                                        \n  protege-calculator.ts            |       0 |        0 |       0 |       0 | 46-424                                                                                                             \n  protege-service.ts               |       0 |        0 |       0 |       0 | 1-428                                                                                                              \n  queue.ts                         |   66.66 |       50 |       0 |   61.29 | 50-52,56-58,62-64,69,73,77,82,91-97                                                                                \n  watcher.ts                       |   32.45 |    68.29 |   13.33 |   32.74 | 78-142,161-191,210-211,216-230,236-245,251-264,270-285,291-306,324,327,330,333,336                                 \n services/agents                   |   10.69 |     6.56 |   11.72 |   10.63 |                                                                                                                    \n  code-quality-agent.ts            |       0 |      100 |       0 |       0 | 6-40                                                                                                               \n  development-coordinator-agent.ts |       0 |        0 |       0 |       0 | 1-434                                                                                                              \n  devops-agent.ts                  |       0 |        0 |       0 |       0 | 1-293                                                                                                              \n  document-parser-agent.ts         |       0 |        0 |       0 |       0 | 10-767                                                                                                             \n  document-parsing-agent.ts        |   56.52 |    34.21 |   68.18 |   55.61 | 61-173,228-251,300,306-308,313-315,344-345,404-425,462-533                                                         \n  estoque-ciap-agent.ts            |       0 |        0 |       0 |       0 | 12-803                                                                                                             \n  federal-agent.ts                 |       0 |        0 |       0 |       0 | 1-789                                                                                                              \n  frontend-dev-agent.ts            |       0 |        0 |       0 |       0 | 1-409                                                                                                              \n  icms-agent.ts                    |       0 |        0 |       0 |       0 | 1-473                                                                                                              \n  icms-apuracao-agent.ts           |       0 |        0 |       0 |       0 | 10-918                                                                                                             \n  icms-apurador-agent.ts           |   56.25 |    39.06 |   54.28 |   55.88 | 170,188,235-244,253-357,402,423-424,427-429,451-455,468-523,601,631,647,666                                        \n  precificacao-margem-agent.ts     |       0 |        0 |       0 |       0 | 12-879                                                                                                             \n  test-fix-agent.ts                |       0 |        0 |       0 |       0 | 1-431                                                                                                              \n services/parsers                  |   34.82 |    25.42 |   20.63 |   36.36 |                                                                                                                    \n  document-parser.ts               |    7.43 |        0 |       4 |    7.91 | 111-493                                                                                                            \n  icms-rules-excel-parser.ts       |      20 |        0 |       0 |      20 | 20-42                                                                                                              \n  protege-pdf-parser.ts            |     5.4 |        0 |       0 |     5.4 | 29-263                                                                                                             \n  sped-contribuicoes-parser.ts     |       5 |        0 |       0 |    5.26 | 28-123                                                                                                             \n  sped-fiscal-parser.ts            |    5.26 |        0 |       0 |    5.55 | 29-123                                                                                                             \n  xml-parser.ts                    |   78.28 |    64.19 |      75 |   84.17 | 103,117-121,270-309,390,449,471,489-538                                                                            \n services/validators               |   13.15 |        0 |       0 |   13.15 |                                                                                                                    \n  integrity-validator.ts           |   13.15 |        0 |       0 |   13.15 | 24-101                                                                                                             \n services/watchers                 |     5.7 |        0 |       0 |     5.8 |                                                                                                                    \n  api-watcher.ts                   |    4.87 |        0 |       0 |       5 | 25-349                                                                                                             \n  email-watcher.ts                 |    6.54 |        0 |       0 |    6.54 | 20-267                                                                                                             \n  ftp-watcher.ts                   |    5.66 |        0 |       0 |    5.88 | 41-152                                                                                                             \n  google-drive-watcher.ts          |    6.66 |        0 |       0 |    6.81 | 26-277                                                                                                             \n  s3-watcher.ts                    |    5.08 |        0 |       0 |    5.17 | 33-370                                                                                                             \n utils                             |   34.31 |       30 |   29.09 |   35.19 |                                                                                                                    \n  br-utils.ts                      |   96.22 |    81.08 |     100 |   96.07 | 217,237,261,280                                                                                                    \n  cache.ts                         |       0 |        0 |       0 |       0 | 1-200                                                                                                              \n  chunking.ts                      |       0 |        0 |       0 |       0 | 5-53                                                                                                               \n  fallback.ts                      |       0 |        0 |       0 |       0 | 4-27                                                                                                               \n  logger.ts                        |       0 |        0 |       0 |       0 | 1-117                                                                                                              \n  prisma.ts                        |     100 |      100 |     100 |     100 |                                                                                                                    \n  rateLimiter.ts                   |       0 |        0 |       0 |       0 | 4-22                                                                                                               \n  retry.ts                         |       0 |        0 |       0 |       0 | 11-26                                                                                                              \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\n",
      "success": false
    },
    {
      "retry": 4,
      "timestamp": "2025-06-23T22:16:01.269Z",
      "stats": {
        "total": 0,
        "passed": 0,
        "failed": 0,
        "skipped": 0,
        "coverage": 14.21
      },
      "output": "\n> sistema-tributario-backend@1.0.0 test\n> jest --coverage --verbose --detectOpenHandles\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/sped-fiscal.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 12345678000195\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/sped-fiscal.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:132:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:132:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/new-company.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 98765432000198\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/new-company.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:214:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:214:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/invalid-file.xyz\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/invalid-file.xyz Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:255:22)\n\n  console.log\n    Agente 2 iniciando processamento em lote: 3 arquivos\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:268:13)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc1.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc2.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc3.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc1.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 0)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc2.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 1)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc3.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 2)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.log\n    Agente 2 lote conclu√≠do: batch_1750716940579_j2y06o {\n      totalFiles: 3,\n      successCount: 0,\n      errorCount: 3,\n      companiesFound: 0,\n      companiesRegistered: 0,\n      processingTime: 23\n    }\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:332:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_123\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.log\n    Dados cadastrais consolidados para empresa: emp_123 {\n      dataSources: [\n        'cnpj: undefined',\n        'razaoSocial: undefined',\n        'ie: undefined',\n        'nomeFantasia: undefined',\n        'cnae: undefined'\n      ],\n      consolidatedFields: [ 'cnpj', 'razaoSocial', 'ie', 'nomeFantasia', 'cnae' ]\n    }\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:378:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_999\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.error\n    Erro ao extrair dados cadastrais: emp_999 {\n      error: Error: Nenhum documento encontrado para a empresa: emp_999\n          at DocumentParsingAgent.extractCompanyDataFromDocuments (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:360:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:373:7)\n    }\n\n    \u001b[0m \u001b[90m 384 |\u001b[39m\n     \u001b[90m 385 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 386 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro ao extrair dados cadastrais: ${companyId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 387 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 388 |\u001b[39m     }\n     \u001b[90m 389 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:386:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:373:7)\n\n  console.log\n    Validando e corrigindo dados: doc_123\n\n      at DocumentParsingAgent.log [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:395:13)\n\n  console.error\n    Erro na validacao e corre√ß√£o: doc_123 {\n      error: Error: Documento n√£o encontrado: doc_123\n          at DocumentParsingAgent.validateAndCorrectData (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:400:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:420:22)\n    }\n\n    \u001b[0m \u001b[90m 426 |\u001b[39m\n     \u001b[90m 427 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 428 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro na validacao e corre√ß√£o: ${documentId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 429 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 430 |\u001b[39m     }\n     \u001b[90m 431 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:428:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:420:22)\n\n  console.log\n    Gerando relat√≥rio de extra√ß√£o { companyId: undefined, dateRange: undefined }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:437:13)\n\n  console.log\n    Relat√≥rio de extra√ß√£o gerado { totalDocuments: 2, companiesProcessed: 1 }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:454:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716941466'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716941466' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716941466',\n      itens: 0,\n      regras: 0,\n      confianca: '30%',\n      tempo: '39ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716941513'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.error\n    ‚ùå AGENTE 3: Erro na apuracao ICMS Error: Erro de teste no cache\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\icms-apurador-agent.test.ts:118:39)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 194 |\u001b[39m\n     \u001b[90m 195 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 196 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'‚ùå AGENTE 3: Erro na apuracao ICMS'\u001b[39m\u001b[33m,\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error \u001b[33m:\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'Unknown error'\u001b[39m))\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 197 |\u001b[39m       \n     \u001b[90m 198 |\u001b[39m       \u001b[36mreturn\u001b[39m {\n     \u001b[90m 199 |\u001b[39m         id\u001b[33m:\u001b[39m apuracaoId\u001b[33m,\u001b[39m\u001b[0m\n\n      at ICMSApuradorAgent.error [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:196:15)\n      at Object.<anonymous> (tests/agents/icms-apurador-agent.test.ts:121:25)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716941559'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716941559' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716941559',\n      itens: 4,\n      regras: 0,\n      confianca: '100%',\n      tempo: '13ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.warn\n    [xmldom warning]\tunclosed xml attribute \n    @#[line:1,col:1]\n\n    \u001b[0m \u001b[90m  97 |\u001b[39m     \u001b[36mtry\u001b[39m {\n     \u001b[90m  98 |\u001b[39m       \u001b[90m// Parse do XML\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m  99 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc \u001b[33m=\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mparser\u001b[33m.\u001b[39mparseFromString(xmlContent\u001b[33m,\u001b[39m \u001b[32m'text/xml'\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 100 |\u001b[39m\n     \u001b[90m 101 |\u001b[39m       \u001b[90m// Verificar se o XML √© v√°lido\u001b[39m\n     \u001b[90m 102 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc\u001b[33m.\u001b[39mgetElementsByTagName(\u001b[32m'parsererror'\u001b[39m)\u001b[33m.\u001b[39mlength \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m) {\u001b[0m\n\n      at DOMHandler.warning (../node_modules/xmldom/lib/dom-parser.js:175:11)\n      at parse (../node_modules/xmldom/lib/sax.js:170:20)\n      at XMLReader.parse (../node_modules/xmldom/lib/sax.js:45:3)\n      at DOMParser.Object.<anonymous>.DOMParser.parseFromString (../node_modules/xmldom/lib/dom-parser.js:25:7)\n      at XMLParser.parseFromString [as parseXML] (src/services/parsers/xml-parser.ts:99:33)\n      at Object.<anonymous> (tests/services/parsers/xml-parser.test.ts:227:30)\n\n  console.error\n    Redis connect failed, using memory fallback Error: Connection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:54:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 124 |\u001b[39m       }\n     \u001b[90m 125 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 126 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Redis connect failed, using memory fallback'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 127 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 128 |\u001b[39m     }\n     \u001b[90m 129 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as connect] (src/services/cache.ts:126:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:58:7)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.error\n    Redis disconnect error Error: Disconnection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:90:21)\n\n    \u001b[0m \u001b[90m 134 |\u001b[39m         \u001b[36mawait\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mclient\u001b[33m.\u001b[39mquit()\u001b[33m;\u001b[39m\n     \u001b[90m 135 |\u001b[39m       } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 136 |\u001b[39m         console\u001b[33m.\u001b[39merror(\u001b[32m'Redis disconnect error'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 137 |\u001b[39m       }\n     \u001b[90m 138 |\u001b[39m     }\n     \u001b[90m 139 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as disconnect] (src/services/cache.ts:136:17)\n      at Object.<anonymous> (tests/services/cache.test.ts:94:7)\n\n  console.error\n    Cache get error, falling back to memory Error: Get failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:121:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 150 |\u001b[39m       \u001b[36mreturn\u001b[39m value \u001b[33m?\u001b[39m \u001b[33mJSON\u001b[39m\u001b[33m.\u001b[39mparse(value) \u001b[33m:\u001b[39m \u001b[36mnull\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 151 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 152 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache get error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 153 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 154 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mget\u001b[39m\u001b[33m<\u001b[39m\u001b[33mT\u001b[39m\u001b[33m>\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 155 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as get] (src/services/cache.ts:152:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:124:22)\n\n  console.error\n    Cache set error, falling back to memory Error: Set failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:156:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 167 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 168 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 169 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache set error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 170 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 171 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mset\u001b[39m(key\u001b[33m,\u001b[39m value\u001b[33m,\u001b[39m ttl)\u001b[33m;\u001b[39m\n     \u001b[90m 172 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as set] (src/services/cache.ts:169:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:160:22)\n\n  console.error\n    Cache delete error, falling back to memory Error: Delete failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:187:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 183 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 184 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 185 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache delete error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 186 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 187 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mdelete\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 188 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as delete] (src/services/cache.ts:185:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:190:22)\n\n  console.error\n    Cache exists error, falling back to memory Error: Exists failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:217:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 199 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m===\u001b[39m \u001b[35m1\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 200 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 201 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache exists error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 202 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 203 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39mexists(key)\u001b[33m;\u001b[39m\n     \u001b[90m 204 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as exists] (src/services/cache.ts:201:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:220:22)\n\n  console.error\n    Cache getOrSet error, falling back to memory Error: Factory failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:272:51)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 567 |\u001b[39m       \u001b[36mreturn\u001b[39m value\u001b[33m;\u001b[39m\n     \u001b[90m 568 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 569 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache getOrSet error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 570 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 571 |\u001b[39m       \n     \u001b[90m 572 |\u001b[39m       \u001b[90m// Tentar buscar do cache primeiro\u001b[39m\u001b[0m\n\n      at CacheService.error [as getOrSet] (src/services/cache.ts:569:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:276:7)\n\n  console.log\n    Cache cleared by pattern { pattern: 'test:*', deleted: 2 }\n\n      at CacheService.log [as clearPattern] (src/services/cache.ts:476:17)\n\n  console.error\n    Cache clearPattern error, falling back to memory Error: Clear failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:292:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 480 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 481 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 482 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache clearPattern error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 483 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 484 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 485 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as clearPattern] (src/services/cache.ts:482:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:295:22)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '2ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.error\n    Erro na requisi√ß√£o OpenAI { error: 'Chave da API OpenAI n√£o configurada', duration: '0ms' }\n\n    \u001b[0m \u001b[90m 213 |\u001b[39m     \u001b[36mconst\u001b[39m duration \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 214 |\u001b[39m     \n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 215 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Erro na requisi√ß√£o OpenAI'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m     |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 216 |\u001b[39m       error\u001b[33m:\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error\u001b[33m.\u001b[39mmessage \u001b[33m:\u001b[39m \u001b[32m'Unknown error'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 217 |\u001b[39m       duration\u001b[33m:\u001b[39m \u001b[32m`${duration}ms`\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 218 |\u001b[39m     })\u001b[33m;\u001b[39m\u001b[0m\n\n      at error (src/services/openai-service.ts:215:13)\n      at makeOpenAIRequest (src/services/openai-service.ts:257:10)\n      at Object.<anonymous> (tests/services/openai-service.test.ts:195:33)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'password: Senha deve ter pelo menos 8 caracteres' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/test',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido', 'password: Senha muito curta' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:84:20)\n\n  console.error\n    Unexpected error in validation middleware Error: Unexpected error\n        at C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:115:13\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:397:39\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:404:13\n        at mockConstructor (C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:148:19)\n        at validateRequest (C:\\luth\\sistema-tributario\\backend\\src\\middleware\\validation.ts:76:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:118:20)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 92 |\u001b[39m     next()\u001b[33m;\u001b[39m\n     \u001b[90m 93 |\u001b[39m   } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 94 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Unexpected error in validation middleware'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m    |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 95 |\u001b[39m     \n     \u001b[90m 96 |\u001b[39m     res\u001b[33m.\u001b[39mstatus(\u001b[33mHTTP_STATUS\u001b[39m\u001b[33m.\u001b[39m\u001b[33mINTERNAL_SERVER_ERROR\u001b[39m)\u001b[33m.\u001b[39mjson({\n     \u001b[90m 97 |\u001b[39m       success\u001b[33m:\u001b[39m \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at error (src/middleware/validation.ts:94:13)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:118:20)\n\n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nFile                               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                  \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nAll files                          |   14.21 |    12.23 |   11.44 |   14.18 |                                                                                                                    \n config                            |      48 |    66.66 |       0 |   43.47 |                                                                                                                    \n  database.ts                      |   38.09 |      100 |       0 |   31.57 | 6-11,17-21,27-28,32-33                                                                                             \n  index.ts                         |     100 |    66.66 |     100 |     100 | 7-17,22-31,39                                                                                                      \n constants                         |   66.66 |       50 |     100 |   66.66 |                                                                                                                    \n  document.ts                      |       0 |      100 |     100 |       0 | 1-23                                                                                                               \n  federal-rules.ts                 |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  icms-rules.ts                    |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  index.ts                         |     100 |       50 |     100 |     100 | 73                                                                                                                 \n middleware                        |    43.6 |    31.48 |   29.16 |   41.66 |                                                                                                                    \n  auth.ts                          |   67.27 |       56 |      50 |      64 | 80,99-117,133-147,164-167                                                                                          \n  cache.ts                         |       0 |        0 |       0 |       0 | 2-117                                                                                                              \n  validation.ts                    |   61.76 |     37.5 |   57.14 |      60 | 38-63                                                                                                              \n routes                            |    4.62 |     0.69 |    1.46 |    4.63 |                                                                                                                    \n  ai.ts                            |       0 |        0 |       0 |       0 | 6-412                                                                                                              \n  auth.ts                          |   69.23 |    21.73 |      75 |   68.25 | 102-103,138,173-174,190-194,202-203,213-258                                                                        \n  dashboard.ts                     |       0 |        0 |       0 |       0 | 1-271                                                                                                              \n  development-agents.ts            |       0 |        0 |       0 |       0 | 1-331                                                                                                              \n  document-parsing.ts              |       0 |        0 |       0 |       0 | 1-284                                                                                                              \n  documents.ts                     |       0 |        0 |       0 |       0 | 1-752                                                                                                              \n  estoque-ciap.ts                  |       0 |        0 |       0 |       0 | 14-319                                                                                                             \n  federal-apuracao.ts              |       0 |        0 |       0 |       0 | 13-562                                                                                                             \n  icms-apuracao.ts                 |       0 |        0 |       0 |       0 | 12-428                                                                                                             \n  icms.ts                          |       0 |        0 |       0 |       0 | 6-455                                                                                                              \n  index.ts                         |   12.12 |      100 |       0 |   12.12 | 21-158                                                                                                             \n  interface-reporting.ts           |       0 |        0 |       0 |       0 | 13-403                                                                                                             \n  multi-empresa.ts                 |       0 |        0 |       0 |       0 | 1-232                                                                                                              \n  parsing.ts                       |    14.6 |        0 |       0 |   15.47 | 28-374                                                                                                             \n  precificacao-margem.ts           |       0 |        0 |       0 |       0 | 12-550                                                                                                             \n  protege.ts                       |       0 |        0 |       0 |       0 | 1-593                                                                                                              \n  sped-reports.ts                  |       0 |        0 |       0 |       0 | 1-320                                                                                                              \n  test.ts                          |       0 |        0 |       0 |       0 | 1-348                                                                                                              \n  upload.ts                        |   27.41 |        0 |       0 |   27.86 | 27-35,45-58,81-136,153-197,213-233,249-286                                                                         \n  users.ts                         |       0 |        0 |       0 |       0 | 1-311                                                                                                              \n services                          |   19.25 |    20.25 |   17.34 |   19.25 |                                                                                                                    \n  batch-processor.ts               |       0 |        0 |       0 |       0 | 1-369                                                                                                              \n  cache.ts                         |   32.16 |    23.42 |   38.63 |   32.46 | 13-18,29,42-47,73-78,86-88,102,106-108,112-114,144,160,177,193,209-460,467,480,495-531,542-550,575,580-581,593-609 \n  document-indexer.ts              |    3.29 |        0 |       0 |    3.48 | 34-433                                                                                                             \n  document-processor.ts            |    5.68 |        0 |       0 |    5.95 | 34-329                                                                                                             \n  empresa-service.ts               |   30.15 |        0 |   36.36 |   30.15 | 64-68,89-93,121-239,263-304                                                                                        \n  icms-apurador.ts                 |       0 |        0 |       0 |       0 | 19-81                                                                                                              \n  multi-empresa-watcher.ts         |       0 |        0 |       0 |       0 | 1-486                                                                                                              \n  openai-service.ts                |   85.52 |    59.18 |   91.66 |   85.52 | 100-101,105-106,111,115,155,377,390,410-418                                                                        \n  protege-calculator.ts            |       0 |        0 |       0 |       0 | 46-424                                                                                                             \n  protege-service.ts               |       0 |        0 |       0 |       0 | 1-428                                                                                                              \n  queue.ts                         |   66.66 |       50 |       0 |   61.29 | 50-52,56-58,62-64,69,73,77,82,91-97                                                                                \n  watcher.ts                       |   32.45 |    68.29 |   13.33 |   32.74 | 78-142,161-191,210-211,216-230,236-245,251-264,270-285,291-306,324,327,330,333,336                                 \n services/agents                   |   10.69 |     6.56 |   11.72 |   10.63 |                                                                                                                    \n  code-quality-agent.ts            |       0 |      100 |       0 |       0 | 6-40                                                                                                               \n  development-coordinator-agent.ts |       0 |        0 |       0 |       0 | 1-434                                                                                                              \n  devops-agent.ts                  |       0 |        0 |       0 |       0 | 1-293                                                                                                              \n  document-parser-agent.ts         |       0 |        0 |       0 |       0 | 10-767                                                                                                             \n  document-parsing-agent.ts        |   56.52 |    34.21 |   68.18 |   55.61 | 61-173,228-251,300,306-308,313-315,344-345,404-425,462-533                                                         \n  estoque-ciap-agent.ts            |       0 |        0 |       0 |       0 | 12-803                                                                                                             \n  federal-agent.ts                 |       0 |        0 |       0 |       0 | 1-789                                                                                                              \n  frontend-dev-agent.ts            |       0 |        0 |       0 |       0 | 1-409                                                                                                              \n  icms-agent.ts                    |       0 |        0 |       0 |       0 | 1-473                                                                                                              \n  icms-apuracao-agent.ts           |       0 |        0 |       0 |       0 | 10-918                                                                                                             \n  icms-apurador-agent.ts           |   56.25 |    39.06 |   54.28 |   55.88 | 170,188,235-244,253-357,402,423-424,427-429,451-455,468-523,601,631,647,666                                        \n  precificacao-margem-agent.ts     |       0 |        0 |       0 |       0 | 12-879                                                                                                             \n  test-fix-agent.ts                |       0 |        0 |       0 |       0 | 1-431                                                                                                              \n services/parsers                  |   34.82 |    25.42 |   20.63 |   36.36 |                                                                                                                    \n  document-parser.ts               |    7.43 |        0 |       4 |    7.91 | 111-493                                                                                                            \n  icms-rules-excel-parser.ts       |      20 |        0 |       0 |      20 | 20-42                                                                                                              \n  protege-pdf-parser.ts            |     5.4 |        0 |       0 |     5.4 | 29-263                                                                                                             \n  sped-contribuicoes-parser.ts     |       5 |        0 |       0 |    5.26 | 28-123                                                                                                             \n  sped-fiscal-parser.ts            |    5.26 |        0 |       0 |    5.55 | 29-123                                                                                                             \n  xml-parser.ts                    |   78.28 |    64.19 |      75 |   84.17 | 103,117-121,270-309,390,449,471,489-538                                                                            \n services/validators               |   13.15 |        0 |       0 |   13.15 |                                                                                                                    \n  integrity-validator.ts           |   13.15 |        0 |       0 |   13.15 | 24-101                                                                                                             \n services/watchers                 |     5.7 |        0 |       0 |     5.8 |                                                                                                                    \n  api-watcher.ts                   |    4.87 |        0 |       0 |       5 | 25-349                                                                                                             \n  email-watcher.ts                 |    6.54 |        0 |       0 |    6.54 | 20-267                                                                                                             \n  ftp-watcher.ts                   |    5.66 |        0 |       0 |    5.88 | 41-152                                                                                                             \n  google-drive-watcher.ts          |    6.66 |        0 |       0 |    6.81 | 26-277                                                                                                             \n  s3-watcher.ts                    |    5.08 |        0 |       0 |    5.17 | 33-370                                                                                                             \n utils                             |   34.31 |       30 |   29.09 |   35.19 |                                                                                                                    \n  br-utils.ts                      |   96.22 |    81.08 |     100 |   96.07 | 217,237,261,280                                                                                                    \n  cache.ts                         |       0 |        0 |       0 |       0 | 1-200                                                                                                              \n  chunking.ts                      |       0 |        0 |       0 |       0 | 5-53                                                                                                               \n  fallback.ts                      |       0 |        0 |       0 |       0 | 4-27                                                                                                               \n  logger.ts                        |       0 |        0 |       0 |       0 | 1-117                                                                                                              \n  prisma.ts                        |     100 |      100 |     100 |     100 |                                                                                                                    \n  rateLimiter.ts                   |       0 |        0 |       0 |       0 | 4-22                                                                                                               \n  retry.ts                         |       0 |        0 |       0 |       0 | 11-26                                                                                                              \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\n",
      "success": false
    },
    {
      "retry": 5,
      "timestamp": "2025-06-23T22:16:31.537Z",
      "stats": {
        "total": 0,
        "passed": 0,
        "failed": 0,
        "skipped": 0,
        "coverage": 14.21
      },
      "output": "\n> sistema-tributario-backend@1.0.0 test\n> jest --coverage --verbose --detectOpenHandles\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/sped-fiscal.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 12345678000195\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/sped-fiscal.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:132:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:132:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/new-company.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.log\n    üè¢ Registrando nova empresa: 98765432000198\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:205:19)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/new-company.txt TypeError: Cannot read properties of undefined (reading 'id')\n        at DocumentParsingAgent.id [as processDocument] (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:224:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:214:22)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:214:22)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/invalid-file.xyz\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/invalid-file.xyz Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:255:22)\n\n  console.log\n    Agente 2 iniciando processamento em lote: 3 arquivos\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:268:13)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc1.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc2.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.log\n    Agente 2 iniciando processamento: /path/to/doc3.txt\n\n      at DocumentParsingAgent.log [as processDocument] (src/services/agents/document-parsing-agent.ts:190:15)\n          at Array.map (<anonymous>)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc1.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 0)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc2.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 1)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.error\n    ‚ùå Erro no Agente 2: /path/to/doc3.txt Error: Tipo de arquivo n√£o suportado\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:239:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 252 |\u001b[39m\n     \u001b[90m 253 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 254 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`‚ùå Erro no Agente 2: ${filePath}`\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 255 |\u001b[39m       result\u001b[33m.\u001b[39mvalidationErrors\u001b[33m.\u001b[39mpush(\u001b[32m`Erro de processamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m 256 |\u001b[39m       result\u001b[33m.\u001b[39mprocessingTime \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 257 |\u001b[39m       \u001b[36mreturn\u001b[39m result\u001b[33m;\u001b[39m\u001b[0m\n\n      at DocumentParsingAgent.error [as processDocument] (src/services/agents/document-parsing-agent.ts:254:15)\n          at async Promise.all (index 2)\n      at DocumentParsingAgent.processBatch (src/services/agents/document-parsing-agent.ts:287:30)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:310:22)\n\n  console.log\n    Agente 2 lote conclu√≠do: batch_1750716970551_6p14ji {\n      totalFiles: 3,\n      successCount: 0,\n      errorCount: 3,\n      companiesFound: 0,\n      companiesRegistered: 0,\n      processingTime: 32\n    }\n\n      at DocumentParsingAgent.log [as processBatch] (src/services/agents/document-parsing-agent.ts:332:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_123\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.log\n    Dados cadastrais consolidados para empresa: emp_123 {\n      dataSources: [\n        'cnpj: undefined',\n        'razaoSocial: undefined',\n        'ie: undefined',\n        'nomeFantasia: undefined',\n        'cnae: undefined'\n      ],\n      consolidatedFields: [ 'cnpj', 'razaoSocial', 'ie', 'nomeFantasia', 'cnae' ]\n    }\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:378:15)\n\n  console.log\n    Extraindo dados cadastrais da empresa: emp_999\n\n      at DocumentParsingAgent.log [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:353:13)\n\n  console.error\n    Erro ao extrair dados cadastrais: emp_999 {\n      error: Error: Nenhum documento encontrado para a empresa: emp_999\n          at DocumentParsingAgent.extractCompanyDataFromDocuments (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:360:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:373:7)\n    }\n\n    \u001b[0m \u001b[90m 384 |\u001b[39m\n     \u001b[90m 385 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 386 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro ao extrair dados cadastrais: ${companyId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 387 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 388 |\u001b[39m     }\n     \u001b[90m 389 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as extractCompanyDataFromDocuments] (src/services/agents/document-parsing-agent.ts:386:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:373:7)\n\n  console.log\n    Validando e corrigindo dados: doc_123\n\n      at DocumentParsingAgent.log [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:395:13)\n\n  console.error\n    Erro na validacao e corre√ß√£o: doc_123 {\n      error: Error: Documento n√£o encontrado: doc_123\n          at DocumentParsingAgent.validateAndCorrectData (C:\\luth\\sistema-tributario\\backend\\src\\services\\agents\\document-parsing-agent.ts:400:15)\n          at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\document-parsing-agent.test.ts:420:22)\n    }\n\n    \u001b[0m \u001b[90m 426 |\u001b[39m\n     \u001b[90m 427 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 428 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m`Erro na validacao e corre√ß√£o: ${documentId}`\u001b[39m\u001b[33m,\u001b[39m { error })\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 429 |\u001b[39m       \u001b[36mthrow\u001b[39m error\u001b[33m;\u001b[39m\n     \u001b[90m 430 |\u001b[39m     }\n     \u001b[90m 431 |\u001b[39m   }\u001b[0m\n\n      at DocumentParsingAgent.error [as validateAndCorrectData] (src/services/agents/document-parsing-agent.ts:428:15)\n      at Object.<anonymous> (tests/agents/document-parsing-agent.test.ts:420:22)\n\n  console.log\n    Gerando relat√≥rio de extra√ß√£o { companyId: undefined, dateRange: undefined }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:437:13)\n\n  console.log\n    Relat√≥rio de extra√ß√£o gerado { totalDocuments: 2, companiesProcessed: 1 }\n\n      at DocumentParsingAgent.log [as generateExtractionReport] (src/services/agents/document-parsing-agent.ts:454:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716971341'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716971341' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716971341',\n      itens: 0,\n      regras: 0,\n      confianca: '30%',\n      tempo: '35ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716971388'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.error\n    ‚ùå AGENTE 3: Erro na apuracao ICMS Error: Erro de teste no cache\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\agents\\icms-apurador-agent.test.ts:118:39)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 194 |\u001b[39m\n     \u001b[90m 195 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 196 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'‚ùå AGENTE 3: Erro na apuracao ICMS'\u001b[39m\u001b[33m,\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error \u001b[33m:\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'Unknown error'\u001b[39m))\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 197 |\u001b[39m       \n     \u001b[90m 198 |\u001b[39m       \u001b[36mreturn\u001b[39m {\n     \u001b[90m 199 |\u001b[39m         id\u001b[33m:\u001b[39m apuracaoId\u001b[33m,\u001b[39m\u001b[0m\n\n      at ICMSApuradorAgent.error [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:196:15)\n      at Object.<anonymous> (tests/agents/icms-apurador-agent.test.ts:121:25)\n\n  console.log\n    üöÄ AGENTE 3: Iniciando apuracao ICMS 100% autonoma {\n      empresaId: 'empresa-123',\n      periodo: '12/2024',\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716971442'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:133:15)\n\n  console.log\n    üîç AGENTE 3: Extraindo regras automaticamente { empresaId: 'empresa-123' }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:229:15)\n\n  console.log\n    ‚úÖ AGENTE 3: Extra√ß√£o de regras conclu√≠da { empresaId: 'empresa-123', regrasExtraidas: 0 }\n\n      at ICMSApuradorAgent.log [as extrairRegrasAutomaticamente] (src/services/agents/icms-apurador-agent.ts:247:15)\n\n  console.log\n    üìä AGENTE 3: Gerando relat√≥rios automaticamente { apuracaoId: 'apuracao_empresa-123_12/2024_1750716971442' }\n\n      at ICMSApuradorAgent.log [as gerarRelatoriosAutomaticamente] (src/services/agents/icms-apurador-agent.ts:657:13)\n\n  console.log\n    ‚úÖ AGENTE 3: Apura√ß√£o ICMS conclu√≠da com sucesso {\n      apuracaoId: 'apuracao_empresa-123_12/2024_1750716971442',\n      itens: 4,\n      regras: 0,\n      confianca: '100%',\n      tempo: '12ms'\n    }\n\n      at ICMSApuradorAgent.log [as apurarICMSAutomatico] (src/services/agents/icms-apurador-agent.ts:185:15)\n\n  console.warn\n    [xmldom warning]\tunclosed xml attribute \n    @#[line:1,col:1]\n\n    \u001b[0m \u001b[90m  97 |\u001b[39m     \u001b[36mtry\u001b[39m {\n     \u001b[90m  98 |\u001b[39m       \u001b[90m// Parse do XML\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m  99 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc \u001b[33m=\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mparser\u001b[33m.\u001b[39mparseFromString(xmlContent\u001b[33m,\u001b[39m \u001b[32m'text/xml'\u001b[39m)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 100 |\u001b[39m\n     \u001b[90m 101 |\u001b[39m       \u001b[90m// Verificar se o XML √© v√°lido\u001b[39m\n     \u001b[90m 102 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mxmlDoc\u001b[33m.\u001b[39mgetElementsByTagName(\u001b[32m'parsererror'\u001b[39m)\u001b[33m.\u001b[39mlength \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m) {\u001b[0m\n\n      at DOMHandler.warning (../node_modules/xmldom/lib/dom-parser.js:175:11)\n      at parse (../node_modules/xmldom/lib/sax.js:170:20)\n      at XMLReader.parse (../node_modules/xmldom/lib/sax.js:45:3)\n      at DOMParser.Object.<anonymous>.DOMParser.parseFromString (../node_modules/xmldom/lib/dom-parser.js:25:7)\n      at XMLParser.parseFromString [as parseXML] (src/services/parsers/xml-parser.ts:99:33)\n      at Object.<anonymous> (tests/services/parsers/xml-parser.test.ts:227:30)\n\n  console.error\n    Redis connect failed, using memory fallback Error: Connection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:54:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 124 |\u001b[39m       }\n     \u001b[90m 125 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 126 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Redis connect failed, using memory fallback'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 127 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 128 |\u001b[39m     }\n     \u001b[90m 129 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as connect] (src/services/cache.ts:126:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:58:7)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.log\n    Redis connected\n\n      at log (src/services/cache.ts:96:15)\n\n  console.error\n    Redis disconnect error Error: Disconnection failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:90:21)\n\n    \u001b[0m \u001b[90m 134 |\u001b[39m         \u001b[36mawait\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mclient\u001b[33m.\u001b[39mquit()\u001b[33m;\u001b[39m\n     \u001b[90m 135 |\u001b[39m       } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 136 |\u001b[39m         console\u001b[33m.\u001b[39merror(\u001b[32m'Redis disconnect error'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 137 |\u001b[39m       }\n     \u001b[90m 138 |\u001b[39m     }\n     \u001b[90m 139 |\u001b[39m   }\u001b[0m\n\n      at CacheService.error [as disconnect] (src/services/cache.ts:136:17)\n      at Object.<anonymous> (tests/services/cache.test.ts:94:7)\n\n  console.error\n    Cache get error, falling back to memory Error: Get failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:121:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 150 |\u001b[39m       \u001b[36mreturn\u001b[39m value \u001b[33m?\u001b[39m \u001b[33mJSON\u001b[39m\u001b[33m.\u001b[39mparse(value) \u001b[33m:\u001b[39m \u001b[36mnull\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 151 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 152 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache get error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 153 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 154 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mget\u001b[39m\u001b[33m<\u001b[39m\u001b[33mT\u001b[39m\u001b[33m>\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 155 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as get] (src/services/cache.ts:152:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:124:22)\n\n  console.error\n    Cache set error, falling back to memory Error: Set failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:156:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 167 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 168 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 169 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache set error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 170 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 171 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mset\u001b[39m(key\u001b[33m,\u001b[39m value\u001b[33m,\u001b[39m ttl)\u001b[33m;\u001b[39m\n     \u001b[90m 172 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as set] (src/services/cache.ts:169:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:160:22)\n\n  console.error\n    Cache delete error, falling back to memory Error: Delete failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:187:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 183 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m>\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 184 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 185 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache delete error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 186 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 187 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39m\u001b[36mdelete\u001b[39m(key)\u001b[33m;\u001b[39m\n     \u001b[90m 188 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as delete] (src/services/cache.ts:185:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:190:22)\n\n  console.error\n    Cache exists error, falling back to memory Error: Exists failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:217:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 199 |\u001b[39m       \u001b[36mreturn\u001b[39m result \u001b[33m===\u001b[39m \u001b[35m1\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 200 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 201 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache exists error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 202 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 203 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mmemoryCache\u001b[33m.\u001b[39mexists(key)\u001b[33m;\u001b[39m\n     \u001b[90m 204 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as exists] (src/services/cache.ts:201:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:220:22)\n\n  console.error\n    Cache getOrSet error, falling back to memory Error: Factory failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:272:51)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 567 |\u001b[39m       \u001b[36mreturn\u001b[39m value\u001b[33m;\u001b[39m\n     \u001b[90m 568 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 569 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache getOrSet error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 570 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 571 |\u001b[39m       \n     \u001b[90m 572 |\u001b[39m       \u001b[90m// Tentar buscar do cache primeiro\u001b[39m\u001b[0m\n\n      at CacheService.error [as getOrSet] (src/services/cache.ts:569:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:276:7)\n\n  console.log\n    Cache cleared by pattern { pattern: 'test:*', deleted: 2 }\n\n      at CacheService.log [as clearPattern] (src/services/cache.ts:476:17)\n\n  console.error\n    Cache clearPattern error, falling back to memory Error: Clear failed\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\services\\cache.test.ts:292:21)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 480 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 481 |\u001b[39m     } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 482 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Cache clearPattern error, falling back to memory'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m     |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 483 |\u001b[39m       \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39museMemoryFallback \u001b[33m=\u001b[39m \u001b[36mtrue\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 484 |\u001b[39m       \u001b[36mreturn\u001b[39m \u001b[35m0\u001b[39m\u001b[33m;\u001b[39m\n     \u001b[90m 485 |\u001b[39m     }\u001b[0m\n\n      at CacheService.error [as clearPattern] (src/services/cache.ts:482:15)\n      at Object.<anonymous> (tests/services/cache.test.ts:295:22)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '1ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.log\n    Requisi√ß√£o OpenAI conclu√≠da { model: 'gpt-4', tokens: 150, cost: '$0.0045', duration: '0ms' }\n\n      at log (src/services/openai-service.ts:196:13)\n\n  console.error\n    Erro na requisi√ß√£o OpenAI { error: 'Chave da API OpenAI n√£o configurada', duration: '0ms' }\n\n    \u001b[0m \u001b[90m 213 |\u001b[39m     \u001b[36mconst\u001b[39m duration \u001b[33m=\u001b[39m \u001b[33mDate\u001b[39m\u001b[33m.\u001b[39mnow() \u001b[33m-\u001b[39m startTime\u001b[33m;\u001b[39m\n     \u001b[90m 214 |\u001b[39m     \n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 215 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Erro na requisi√ß√£o OpenAI'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m     |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 216 |\u001b[39m       error\u001b[33m:\u001b[39m error \u001b[36minstanceof\u001b[39m \u001b[33mError\u001b[39m \u001b[33m?\u001b[39m error\u001b[33m.\u001b[39mmessage \u001b[33m:\u001b[39m \u001b[32m'Unknown error'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 217 |\u001b[39m       duration\u001b[33m:\u001b[39m \u001b[32m`${duration}ms`\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 218 |\u001b[39m     })\u001b[33m;\u001b[39m\u001b[0m\n\n      at error (src/services/openai-service.ts:215:13)\n      at makeOpenAIRequest (src/services/openai-service.ts:257:10)\n      at Object.<anonymous> (tests/services/openai-service.test.ts:195:33)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/register',\n      method: 'POST',\n      errors: [ 'password: Senha deve ter pelo menos 8 caracteres' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Layer.handle [as handle_request] (../node_modules/express/lib/router/layer.js:95:5)\n      at next (../node_modules/express/lib/router/route.js:149:13)\n      at middleware (../node_modules/express-validator/lib/middlewares/check.js:16:13)\n\n  console.error\n    Validation failed {\n      path: '/test',\n      method: 'POST',\n      errors: [ 'email: Email inv√°lido', 'password: Senha muito curta' ]\n    }\n\n    \u001b[0m \u001b[90m 80 |\u001b[39m       \n     \u001b[90m 81 |\u001b[39m       \u001b[90m// Log dos erros para debugging\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 82 |\u001b[39m       console\u001b[33m.\u001b[39merror(\u001b[32m'Validation failed'\u001b[39m\u001b[33m,\u001b[39m {\n     \u001b[90m    |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 83 |\u001b[39m         path\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mpath\u001b[33m,\u001b[39m\n     \u001b[90m 84 |\u001b[39m         method\u001b[33m:\u001b[39m req\u001b[33m.\u001b[39mmethod\u001b[33m,\u001b[39m\n     \u001b[90m 85 |\u001b[39m         errors\u001b[33m:\u001b[39m formattedErrors\u001b[33m.\u001b[39mdetails\u001b[0m\n\n      at error (src/middleware/validation.ts:82:15)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:84:20)\n\n  console.error\n    Unexpected error in validation middleware Error: Unexpected error\n        at C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:115:13\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:397:39\n        at C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:404:13\n        at mockConstructor (C:\\luth\\sistema-tributario\\node_modules\\jest-mock\\build\\index.js:148:19)\n        at validateRequest (C:\\luth\\sistema-tributario\\backend\\src\\middleware\\validation.ts:76:36)\n        at Object.<anonymous> (C:\\luth\\sistema-tributario\\backend\\tests\\middleware\\validation.test.ts:118:20)\n        at Promise.then.completed (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:298:28)\n        at new Promise (<anonymous>)\n        at callAsyncCircusFn (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\utils.js:231:10)\n        at _callCircusTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:316:40)\n        at _runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:252:3)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:126:9)\n        at _runTestsForDescribeBlock (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:121:9)\n        at run (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\run.js:71:3)\n        at runAndTransformResultsToJestFormat (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n        at jestAdapter (C:\\luth\\sistema-tributario\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n        at runTestInternal (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n        at runTest (C:\\luth\\sistema-tributario\\node_modules\\jest-runner\\build\\runTest.js:444:34)\n\n    \u001b[0m \u001b[90m 92 |\u001b[39m     next()\u001b[33m;\u001b[39m\n     \u001b[90m 93 |\u001b[39m   } \u001b[36mcatch\u001b[39m (error) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 94 |\u001b[39m     console\u001b[33m.\u001b[39merror(\u001b[32m'Unexpected error in validation middleware'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n     \u001b[90m    |\u001b[39m             \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 95 |\u001b[39m     \n     \u001b[90m 96 |\u001b[39m     res\u001b[33m.\u001b[39mstatus(\u001b[33mHTTP_STATUS\u001b[39m\u001b[33m.\u001b[39m\u001b[33mINTERNAL_SERVER_ERROR\u001b[39m)\u001b[33m.\u001b[39mjson({\n     \u001b[90m 97 |\u001b[39m       success\u001b[33m:\u001b[39m \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at error (src/middleware/validation.ts:94:13)\n      at Object.<anonymous> (tests/middleware/validation.test.ts:118:20)\n\n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nFile                               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                  \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\nAll files                          |   14.21 |    12.23 |   11.44 |   14.18 |                                                                                                                    \n config                            |      48 |    66.66 |       0 |   43.47 |                                                                                                                    \n  database.ts                      |   38.09 |      100 |       0 |   31.57 | 6-11,17-21,27-28,32-33                                                                                             \n  index.ts                         |     100 |    66.66 |     100 |     100 | 7-17,22-31,39                                                                                                      \n constants                         |   66.66 |       50 |     100 |   66.66 |                                                                                                                    \n  document.ts                      |       0 |      100 |     100 |       0 | 1-23                                                                                                               \n  federal-rules.ts                 |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  icms-rules.ts                    |       0 |      100 |     100 |       0 | 2                                                                                                                  \n  index.ts                         |     100 |       50 |     100 |     100 | 73                                                                                                                 \n middleware                        |    43.6 |    31.48 |   29.16 |   41.66 |                                                                                                                    \n  auth.ts                          |   67.27 |       56 |      50 |      64 | 80,99-117,133-147,164-167                                                                                          \n  cache.ts                         |       0 |        0 |       0 |       0 | 2-117                                                                                                              \n  validation.ts                    |   61.76 |     37.5 |   57.14 |      60 | 38-63                                                                                                              \n routes                            |    4.62 |     0.69 |    1.46 |    4.63 |                                                                                                                    \n  ai.ts                            |       0 |        0 |       0 |       0 | 6-412                                                                                                              \n  auth.ts                          |   69.23 |    21.73 |      75 |   68.25 | 102-103,138,173-174,190-194,202-203,213-258                                                                        \n  dashboard.ts                     |       0 |        0 |       0 |       0 | 1-271                                                                                                              \n  development-agents.ts            |       0 |        0 |       0 |       0 | 1-331                                                                                                              \n  document-parsing.ts              |       0 |        0 |       0 |       0 | 1-284                                                                                                              \n  documents.ts                     |       0 |        0 |       0 |       0 | 1-752                                                                                                              \n  estoque-ciap.ts                  |       0 |        0 |       0 |       0 | 14-319                                                                                                             \n  federal-apuracao.ts              |       0 |        0 |       0 |       0 | 13-562                                                                                                             \n  icms-apuracao.ts                 |       0 |        0 |       0 |       0 | 12-428                                                                                                             \n  icms.ts                          |       0 |        0 |       0 |       0 | 6-455                                                                                                              \n  index.ts                         |   12.12 |      100 |       0 |   12.12 | 21-158                                                                                                             \n  interface-reporting.ts           |       0 |        0 |       0 |       0 | 13-403                                                                                                             \n  multi-empresa.ts                 |       0 |        0 |       0 |       0 | 1-232                                                                                                              \n  parsing.ts                       |    14.6 |        0 |       0 |   15.47 | 28-374                                                                                                             \n  precificacao-margem.ts           |       0 |        0 |       0 |       0 | 12-550                                                                                                             \n  protege.ts                       |       0 |        0 |       0 |       0 | 1-593                                                                                                              \n  sped-reports.ts                  |       0 |        0 |       0 |       0 | 1-320                                                                                                              \n  test.ts                          |       0 |        0 |       0 |       0 | 1-348                                                                                                              \n  upload.ts                        |   27.41 |        0 |       0 |   27.86 | 27-35,45-58,81-136,153-197,213-233,249-286                                                                         \n  users.ts                         |       0 |        0 |       0 |       0 | 1-311                                                                                                              \n services                          |   19.25 |    20.25 |   17.34 |   19.25 |                                                                                                                    \n  batch-processor.ts               |       0 |        0 |       0 |       0 | 1-369                                                                                                              \n  cache.ts                         |   32.16 |    23.42 |   38.63 |   32.46 | 13-18,29,42-47,73-78,86-88,102,106-108,112-114,144,160,177,193,209-460,467,480,495-531,542-550,575,580-581,593-609 \n  document-indexer.ts              |    3.29 |        0 |       0 |    3.48 | 34-433                                                                                                             \n  document-processor.ts            |    5.68 |        0 |       0 |    5.95 | 34-329                                                                                                             \n  empresa-service.ts               |   30.15 |        0 |   36.36 |   30.15 | 64-68,89-93,121-239,263-304                                                                                        \n  icms-apurador.ts                 |       0 |        0 |       0 |       0 | 19-81                                                                                                              \n  multi-empresa-watcher.ts         |       0 |        0 |       0 |       0 | 1-486                                                                                                              \n  openai-service.ts                |   85.52 |    59.18 |   91.66 |   85.52 | 100-101,105-106,111,115,155,377,390,410-418                                                                        \n  protege-calculator.ts            |       0 |        0 |       0 |       0 | 46-424                                                                                                             \n  protege-service.ts               |       0 |        0 |       0 |       0 | 1-428                                                                                                              \n  queue.ts                         |   66.66 |       50 |       0 |   61.29 | 50-52,56-58,62-64,69,73,77,82,91-97                                                                                \n  watcher.ts                       |   32.45 |    68.29 |   13.33 |   32.74 | 78-142,161-191,210-211,216-230,236-245,251-264,270-285,291-306,324,327,330,333,336                                 \n services/agents                   |   10.69 |     6.56 |   11.72 |   10.63 |                                                                                                                    \n  code-quality-agent.ts            |       0 |      100 |       0 |       0 | 6-40                                                                                                               \n  development-coordinator-agent.ts |       0 |        0 |       0 |       0 | 1-434                                                                                                              \n  devops-agent.ts                  |       0 |        0 |       0 |       0 | 1-293                                                                                                              \n  document-parser-agent.ts         |       0 |        0 |       0 |       0 | 10-767                                                                                                             \n  document-parsing-agent.ts        |   56.52 |    34.21 |   68.18 |   55.61 | 61-173,228-251,300,306-308,313-315,344-345,404-425,462-533                                                         \n  estoque-ciap-agent.ts            |       0 |        0 |       0 |       0 | 12-803                                                                                                             \n  federal-agent.ts                 |       0 |        0 |       0 |       0 | 1-789                                                                                                              \n  frontend-dev-agent.ts            |       0 |        0 |       0 |       0 | 1-409                                                                                                              \n  icms-agent.ts                    |       0 |        0 |       0 |       0 | 1-473                                                                                                              \n  icms-apuracao-agent.ts           |       0 |        0 |       0 |       0 | 10-918                                                                                                             \n  icms-apurador-agent.ts           |   56.25 |    39.06 |   54.28 |   55.88 | 170,188,235-244,253-357,402,423-424,427-429,451-455,468-523,601,631,647,666                                        \n  precificacao-margem-agent.ts     |       0 |        0 |       0 |       0 | 12-879                                                                                                             \n  test-fix-agent.ts                |       0 |        0 |       0 |       0 | 1-431                                                                                                              \n services/parsers                  |   34.82 |    25.42 |   20.63 |   36.36 |                                                                                                                    \n  document-parser.ts               |    7.43 |        0 |       4 |    7.91 | 111-493                                                                                                            \n  icms-rules-excel-parser.ts       |      20 |        0 |       0 |      20 | 20-42                                                                                                              \n  protege-pdf-parser.ts            |     5.4 |        0 |       0 |     5.4 | 29-263                                                                                                             \n  sped-contribuicoes-parser.ts     |       5 |        0 |       0 |    5.26 | 28-123                                                                                                             \n  sped-fiscal-parser.ts            |    5.26 |        0 |       0 |    5.55 | 29-123                                                                                                             \n  xml-parser.ts                    |   78.28 |    64.19 |      75 |   84.17 | 103,117-121,270-309,390,449,471,489-538                                                                            \n services/validators               |   13.15 |        0 |       0 |   13.15 |                                                                                                                    \n  integrity-validator.ts           |   13.15 |        0 |       0 |   13.15 | 24-101                                                                                                             \n services/watchers                 |     5.7 |        0 |       0 |     5.8 |                                                                                                                    \n  api-watcher.ts                   |    4.87 |        0 |       0 |       5 | 25-349                                                                                                             \n  email-watcher.ts                 |    6.54 |        0 |       0 |    6.54 | 20-267                                                                                                             \n  ftp-watcher.ts                   |    5.66 |        0 |       0 |    5.88 | 41-152                                                                                                             \n  google-drive-watcher.ts          |    6.66 |        0 |       0 |    6.81 | 26-277                                                                                                             \n  s3-watcher.ts                    |    5.08 |        0 |       0 |    5.17 | 33-370                                                                                                             \n utils                             |   34.31 |       30 |   29.09 |   35.19 |                                                                                                                    \n  br-utils.ts                      |   96.22 |    81.08 |     100 |   96.07 | 217,237,261,280                                                                                                    \n  cache.ts                         |       0 |        0 |       0 |       0 | 1-200                                                                                                              \n  chunking.ts                      |       0 |        0 |       0 |       0 | 5-53                                                                                                               \n  fallback.ts                      |       0 |        0 |       0 |       0 | 4-27                                                                                                               \n  logger.ts                        |       0 |        0 |       0 |       0 | 1-117                                                                                                              \n  prisma.ts                        |     100 |      100 |     100 |     100 |                                                                                                                    \n  rateLimiter.ts                   |       0 |        0 |       0 |       0 | 4-22                                                                                                               \n  retry.ts                         |       0 |        0 |       0 |       0 | 11-26                                                                                                              \n-----------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------\n",
      "success": false
    }
  ],
  "finalStats": {
    "total": 0,
    "passed": 0,
    "failed": 0,
    "skipped": 0,
    "coverage": 14.21
  },
  "success": false,
  "summary": {
    "buildSuccess": true,
    "testsPassed": false,
    "coverage": 14.21,
    "totalTests": 0,
    "passedTests": 0,
    "failedTests": 0
  }
}